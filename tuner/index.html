<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenMet Tuner</title>
<link rel="stylesheet" href="../index.html">
<style>
body{margin:0;font-family:sans-serif;background:#0f1220;color:#e8ebff;display:grid;place-items:center;min-height:100vh}
.card{width:min(1000px,100%);background:#161a2b;border-radius:20px;padding:20px;position:relative}
h1{margin:0 0 10px;display:flex;justify-content:space-between;align-items:center}
.panel{background:#0f1530;border:1px solid #212848;border-radius:16px;padding:16px;margin-top:12px}
.tuner-display{display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:30px;}
.note{font-size:5em;font-weight:bold;letter-spacing:0.1em;}
.cents{font-size:2em;margin-top:10px;}
.bar-bg{width:320px;height:18px;background:#23284a;border-radius:9px;position:relative;overflow:hidden;}
.bar-fg{height:100%;position:absolute;top:0;left:50%;transform:translateX(-50%);transition:left 0.1s;}
.bar-fg-indicator{width:4px;height:100%;background:#7c9cff;position:absolute;top:0;left:50%;transform:translateX(-50%);border-radius:2px;}
.bar-labels{display:flex;justify-content:space-between;width:320px;font-size:1em;color:#8b9bb4;margin-top:2px;}
.status{margin-top:18px;font-size:1.1em;color:#f87171;}
.light-mode{background:#f8fafc;color:#1e293b;}
.light-mode .card{background:#fff;border:1px solid #e2e8f0;}
.light-mode .panel{background:#f1f5f9;border:1px solid #cbd5e1;}
.light-mode .tuner-display .note,.light-mode .tuner-display .cents{color:#1e293b;}
.light-mode .bar-bg{background:#e2e8f0;}
.light-mode .bar-fg-indicator{background:#3b82f6;}
.light-mode .bar-labels{color:#64748b;}
.light-mode .status{color:#f87171;}
.light-mode select,.light-mode input[type="checkbox"]{background:#fff;color:#1e293b;border:1px solid #cbd5e1;}
/* Flashbang overlay */
#flashbangOverlay {
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: white;
  opacity: 0;
  pointer-events: none;
  z-index: 9999;
  transition: opacity 0.5s;
  filter: blur(0px);
}
#flashbangOverlay.active {
  opacity: 1;
  filter: blur(8px);
  transition: opacity 0.1s, filter 0.1s;
}
/* Toggle switch styles (match metronome) */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #2a3358;
  transition: .4s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: #8b9bb4;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #7c9cff;
}
input:checked + .slider:before {
  transform: translateX(26px);
  background-color: #fff;
}
.light-mode .toggle-switch .slider {
  background-color: #cbd5e1;
}
.light-mode .toggle-switch .slider:before {
  background-color: #64748b;
}
.light-mode input:checked + .slider {
  background-color: #3b82f6;
}
.light-mode input:checked + .slider:before {
  background-color: #fff;
}
@media (max-width: 700px) {
	.card {width:98vw;padding:8px;border-radius:0;}
	.panel {padding:8px;margin-top:8px;border-radius:10px;}
	.tuner-display {gap:12px;margin-top:18px;}
	.note {font-size:3em;}
	.cents {font-size:1.2em;}
	.bar-bg, .bar-labels {width:98vw;max-width:320px;}
}
</style>
</head>
<body>
	<!-- Metronome link top right -->
	<a href="https://open-met.org" style="position:fixed;top:18px;right:24px;z-index:300;color:#7c9cff;text-decoration:none;font-size:1em;padding:8px 18px;border-radius:10px;background:#23284a;box-shadow:0 2px 8px #0003;transition:background 0.2s;display:inline-block;">Metronome</a>
<!-- Flashbang sound and overlay -->
<audio id="flashbangSound" src="../SFX/flashbang.mp3" preload="auto"></audio>
<div id="flashbangOverlay"></div>
<div class="card">
	<h1>OpenMet Tuner</h1>
	<div style="display:flex;gap:18px;flex-wrap:wrap">
		<div class="panel" style="flex:2 1 320px;min-width:260px;">
			<div class="tuner-display">
				<div class="note" id="note">--</div>
				<div class="cents" id="cents">--</div>
				<div class="bar-bg">
					<div class="bar-fg-indicator" id="barIndicator"></div>
				</div>
				<div class="bar-labels"><span>-50¢</span><span>In Tune</span><span>+50¢</span></div>
				<div class="status" id="status"></div>
			</div>
		</div>
		<div class="panel" style="flex:1 1 220px;min-width:180px;max-width:320px;">
			<h2 style="margin-top:0;font-size:1.2em">Settings</h2>
			<div style="margin-bottom:18px">
				<label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
					<span>Light Mode</span>
					<label class="toggle-switch">
						<input type="checkbox" id="lightModeToggle">
						<span class="slider"></span>
					</label>
				</label>
			</div>
			<div>
				<label for="transposeSelect" style="display:block;margin-bottom:8px">Instrument Key</label>
				<select id="transposeSelect" style="width:100%;padding:6px 10px;border-radius:8px;border:1px solid #2a3358;background:#0e1433;color:#fff">
					<option value="0">C (Concert)</option>
					<option value="2">D</option>
					<option value="3">Eb</option>
					<option value="5">F</option>
					<option value="7">G</option>
					<option value="9">A</option>
					<option value="10">Bb</option>
				</select>
			</div>
		</div>
	</div>
	<div style="position:fixed;bottom:10px;left:10px;z-index:100;font-size:13px;color:#8b9bb4;display:flex;align-items:center;gap:10px;">
		<span>OpenMet © 2025 by Slater Feistner</span>
		<a href="https://github.com/PossiblySlater/OpenMet" target="_blank" style="color:#7c9cff;text-decoration:none;display:flex;align-items:center;gap:4px;">GitHub</a>
	</div>
</div>
<script>
// --- Tuner Logic ---
const noteElem = document.getElementById('note');
const centsElem = document.getElementById('cents');
const barIndicator = document.getElementById('barIndicator');
const statusElem = document.getElementById('status');
const transposeSelect = document.getElementById('transposeSelect');
const lightModeToggle = document.getElementById('lightModeToggle');

const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
let transpose = 0;

function autoCorrelate(buf, sampleRate) {
	// Basic auto-correlation algorithm for pitch detection
	let SIZE = buf.length;
	let rms = 0;
	for (let i = 0; i < SIZE; i++) {
		let val = buf[i];
		rms += val * val;
	}
	rms = Math.sqrt(rms / SIZE);
	if (rms < 0.01) return -1; // Too quiet

	let r1 = 0, r2 = SIZE - 1, thres = 0.2;
	for (let i = 0; i < SIZE / 2; i++) {
		if (Math.abs(buf[i]) < thres) { r1 = i; break; }
	}
	for (let i = 1; i < SIZE / 2; i++) {
		if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
	}

	buf = buf.slice(r1, r2);
	SIZE = buf.length;

	let c = new Array(SIZE).fill(0);
	for (let i = 0; i < SIZE; i++) {
		for (let j = 0; j < SIZE - i; j++) {
			c[i] = c[i] + buf[j] * buf[j + i];
		}
	}
	let d = 0; while (c[d] > c[d + 1]) d++;
	let maxval = -1, maxpos = -1;
	for (let i = d; i < SIZE; i++) {
		if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
	}
	let T0 = maxpos;
	if (T0 === -1) return -1;
	return sampleRate / T0;
}

function getNote(frequency) {
	const A4 = 440;
	const noteNum = 12 * (Math.log(frequency / A4) / Math.log(2));
	return Math.round(noteNum) + 69;
}

function noteNameFromMidi(midi) {
	// Apply transposition
	let transposedMidi = midi + transpose;
	return noteStrings[transposedMidi % 12] + Math.floor(transposedMidi / 12 - 1);
}

function getCents(frequency, midi) {
	const A4 = 440;
	const noteFreq = A4 * Math.pow(2, (midi - 69) / 12);
	return Math.floor(1200 * Math.log2(frequency / noteFreq));
}

let audioContext, analyser, buflen = 2048, buf, source;

async function startTuner() {
	try {
		audioContext = new (window.AudioContext || window.webkitAudioContext)();
		const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
		source = audioContext.createMediaStreamSource(stream);
		analyser = audioContext.createAnalyser();
		analyser.fftSize = buflen;
		source.connect(analyser);
		buf = new Float32Array(buflen);
		updateTuner();
		statusElem.textContent = '';
	} catch (e) {
		statusElem.textContent = 'Microphone access denied or unavailable.';
	}
}

function updateTuner() {
	analyser.getFloatTimeDomainData(buf);
	const freq = autoCorrelate(buf, audioContext.sampleRate);
	// --- Smoothing logic ---
	if (!window._centsHistory) window._centsHistory = [];
	if (!window._lastLeft) window._lastLeft = 50;
	if (freq > 50 && freq < 2000) {
		const midi = getNote(freq);
		const note = noteNameFromMidi(midi);
		const cents = getCents(freq, midi);
		window._centsHistory.push(cents);
		if (window._centsHistory.length > 8) window._centsHistory.shift();
		const avgCents = window._centsHistory.reduce((a,b)=>a+b,0)/window._centsHistory.length;
		noteElem.textContent = note;
		centsElem.textContent = (avgCents > 0 ? '+' : '') + Math.round(avgCents) + '¢';
		let pct = Math.max(-50, Math.min(50, avgCents));
		let targetLeft = 50 + pct;
		window._lastLeft = window._lastLeft + (targetLeft - window._lastLeft) * 0.25;
		barIndicator.style.left = window._lastLeft + '%';
		barIndicator.style.background = Math.abs(avgCents) <= 5 ? '#34d399' : '#7c9cff';
	} else {
		noteElem.textContent = '--';
		centsElem.textContent = '--';
		window._centsHistory = [];
		window._lastLeft = window._lastLeft + (50 - window._lastLeft) * 0.25;
		barIndicator.style.left = window._lastLeft + '%';
		barIndicator.style.background = '#7c9cff';
	}
	requestAnimationFrame(updateTuner);
}
// --- Settings Logic ---
transposeSelect.onchange = function() {
	transpose = Number(this.value);
	localStorage.setItem('openmet-tuner-transpose', transpose);
};
// Load saved transpose
const savedTranspose = localStorage.getItem('openmet-tuner-transpose');
if (savedTranspose !== null) {
	transpose = Number(savedTranspose);
	transposeSelect.value = savedTranspose;
}

lightModeToggle.onchange = function() {
  if (this.checked) {
    // Flashbang effect
    const overlay = document.getElementById('flashbangOverlay');
    const sound = document.getElementById('flashbangSound');
    overlay.classList.add('active');
    overlay.style.opacity = '1';
    overlay.style.filter = 'blur(8px)';
    if (sound) {
      sound.currentTime = 0;
      sound.play();
    }
    setTimeout(() => {
      overlay.style.transition = 'opacity 2s, filter 2s';
      overlay.style.opacity = '0';
      overlay.style.filter = 'blur(0px)';
      setTimeout(() => {
        overlay.classList.remove('active');
        overlay.style.transition = '';
      }, 2000);
    }, 1200);
    document.body.classList.add('light-mode');
    localStorage.setItem('openmet-tuner-lightmode', 'true');
  } else {
    document.body.classList.remove('light-mode');
    localStorage.setItem('openmet-tuner-lightmode', 'false');
  }
};
// Load saved light mode
if (localStorage.getItem('openmet-tuner-lightmode') === 'true') {
  lightModeToggle.checked = true;
  document.body.classList.add('light-mode');
}

startTuner();
</script>
</body>
</html>

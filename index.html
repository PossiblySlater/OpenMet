<!DOCTYPE html>
<html lang="en">
<head>
<!-- this code is really fucking messy-->
<!-- i am genuinely sorry -->
<audio id="microwaveSound" src="SFX/microwave.mp3" preload="auto"></audio>
<audio id="cornerCheerSound" src="SFX/cornercheer.mp3" preload="auto"></audio>
<!-- Metronome sounds -->
<audio id="clickSound" src="metsounds/click/click.mp3" preload="auto"></audio>
<audio id="accentClickSound" src="metsounds/click/accentclick.mp3" preload="auto"></audio>
<audio id="clinicianSound" src="metsounds/clinician/clinician.mp3" preload="auto"></audio>
<audio id="accentClinicianSound" src="metsounds/clinician/accentclinician.mp3" preload="auto"></audio>
<style>
#dvdLogo {
  position: fixed;
  width: 120px;
  height: 80px;
  z-index: 99999;
  pointer-events: none;
  display: none;
}
</style>
<audio id="flashbangSound" src="SFX/flashbang.mp3" preload="auto"></audio>
<audio id="powerdownSound" src="SFX/powerdown.mp3" preload="auto"></audio>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenMet</title>
<!-- themes and shit -->
<style>
body.ultra-dark .toggle-switch,
body.ultra-dark .slider,
body.ultra-dark input[type="checkbox"] {
  display: none !important;
}
/* Ultra-Dark Theme: everything black */
body.ultra-dark, body.ultra-dark * {
  background: #000 !important;
  color: #000 !important;
  border-color: #000 !important;
  box-shadow: none !important;
}
body.ultra-dark #led {
  background: #000 !important;
}
body.ultra-dark .slider {
  background: #000 !important;
}
body.ultra-dark .settings-tab, body.ultra-dark .settings-tab.active {
  background: #000 !important;
  color: #000 !important;
  border-bottom: 2px solid #000 !important;
}
/* Toggle and beat indicator styles for all themes */
body.solarized-dark .toggle-switch .slider {
  background-color: #586e75 !important;
}
body.solarized-dark .toggle-switch .slider:before {
  background-color: #b58900 !important;
}
body.solarized-dark input:checked + .slider {
  background-color: #b58900 !important;
}
body.solarized-dark input:checked + .slider:before {
  background-color: #002b36 !important;
}
body.solarized-light .toggle-switch .slider {
  background-color: #93a1a1 !important;
}
body.solarized-light .toggle-switch .slider:before {
  background-color: #b58900 !important;
}
body.solarized-light input:checked + .slider {
  background-color: #b58900 !important;
}
body.solarized-light input:checked + .slider:before {
  background-color: #fdf6e3 !important;
}
body.monochrome .toggle-switch .slider {
  background-color: #888 !important;
}
body.monochrome .toggle-switch .slider:before {
  background-color: #eee !important;
}
body.monochrome input:checked + .slider {
  background-color: #eee !important;
}
body.monochrome input:checked + .slider:before {
  background-color: #222 !important;
}
body.pastel .toggle-switch .slider {
  background-color: #c8b6ff !important;
}
body.pastel .toggle-switch .slider:before {
  background-color: #f7f3fa !important;
}
body.pastel input:checked + .slider {
  background-color: #6c5b7b !important;
}
body.pastel input:checked + .slider:before {
  background-color: #fceff9 !important;
}
body.retro .toggle-switch .slider {
  background-color: #f2e9e4 !important;
}
body.retro .toggle-switch .slider:before {
  background-color: #22223b !important;
}
body.retro input:checked + .slider {
  background-color: #9a8c98 !important;
}
body.retro input:checked + .slider:before {
  background-color: #f2e9e4 !important;
}
body.ocean .toggle-switch .slider {
  background-color: #3bb3c3 !important;
}
body.ocean .toggle-switch .slider:before {
  background-color: #a7e9e6 !important;
}
body.ocean input:checked + .slider {
  background-color: #176582 !important;
}
body.ocean input:checked + .slider:before {
  background-color: #0e2f44 !important;
}
/* Theme dropdown styles for each mode */
body.light-mode #themeSelect {
  background: #fff !important;
  color: #1e293b !important;
  border: 1px solid #cbd5e1 !important;
}
body.high-contrast #themeSelect {
  background: #000 !important;
  color: #fff !important;
  border: 2px solid #fff !important;
}
/* Flashbang overlay */
#flashbangOverlay {
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: white;
  opacity: 0;
  pointer-events: none;
  z-index: 9999;
  transition: opacity 0.5s;
  filter: blur(0px);
}
#flashbangOverlay.active {
  opacity: 1;
  filter: blur(8px);
  transition: opacity 0.1s, filter 0.1s;
}
/* --- GENERAL STYLES --- */
body{margin:0;font-family:sans-serif;background:#0f1220;color:#e8ebff;display:grid;place-items:center;min-height:100vh}
.card{width:min(1000px,100%);background:#161a2b;border-radius:20px;padding:20px;position:relative}
h1{margin:0 0 10px;display:flex;justify-content:space-between;align-items:center}
.panel{background:#0f1530;border:1px solid #212848;border-radius:16px;padding:16px;margin-top:12px}
input,select,button{padding:6px 10px;border-radius:8px;border:1px solid #2a3358;background:#0e1433;color:#fff}
button{cursor:pointer}
button[title] {
  font-size: 16px;
  min-width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Remove number input spinners */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -webkit-appearance: textfield;
  -moz-appearance: textfield;
  appearance: textfield;
}
.btn.primary{background:#7c9cff;border:none;color:#ffffff}
.btn.success{background:#34d399;border:none}
.btn.danger{background:#f87171;border:none;color:#ffffff}
.btn.ghost{background:#0e1433;border:1px solid #2a3358}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px 8px;text-align:center;border-bottom:1px solid #2a3358}
tr.active-set{background:#1b2347}
.info-icon{cursor:pointer;font-size:20px}
#infoPanel{position:absolute;top:20px;right:20px;width:300px;background:#0f1530;border:1px solid #212848;border-radius:12px;padding:16px;display:none;z-index:10}
#infoPanel h2{margin:0 0 6px;font-size:18px}
#infoPanel p{margin:0;font-size:14px;line-height:1.4}
#closeInfo{cursor:pointer;color:#f87171;float:right;font-weight:bold}

/* Settings icon styling */
.settings-icon {
  cursor: pointer;
  font-size: 20px;
  padding: 4px;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.settings-icon:hover {
  background-color: rgba(124, 156, 255, 0.2);
}

/* Settings panel styles */
#settingsPanel{position:absolute;top:20px;right:20px;width:300px;background:#0f1530;border:1px solid #212848;border-radius:12px;padding:16px;display:none;z-index:10}
#settingsPanel h2{margin:0 0 12px;font-size:18px}
#settingsPanel h3{margin:12px 0 8px;font-size:14px;color:#8b9bb4}
.setting-group{margin-bottom:16px}
#closeSettings{cursor:pointer;color:#f87171;float:right;font-weight:bold}

/* Settings tabs */
.settings-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
  max-width: 320px;
}
.settings-tab {
  flex: 1 1 45%;
  margin-bottom: 8px;
}
.settings-tab {
  padding: 6px 16px;
  border-radius: 8px 8px 0 0;
  background: #161a2b;
  color: #7c9cff;
  cursor: pointer;
  border: none;
  outline: none;
  font-weight: bold;
  transition: background 0.2s;
}
.settings-tab.active {
  background: #0f1530;
  color: #fff;
  border-bottom: 2px solid #7c9cff;
}
body.light-mode .settings-tab {
  background: #f1f5f9;
  color: #3b82f6;
}
body.light-mode .settings-tab.active {
  background: #fff;
  color: #1e293b;
  border-bottom: 2px solid #3b82f6;
}

/* Light mode styles */
body.light-mode{background:#f8fafc;color:#1e293b}
body.light-mode .card{background:#ffffff;border:1px solid #e2e8f0}
body.light-mode .panel{background:#f1f5f9;border:1px solid #cbd5e1}
body.light-mode input,body.light-mode select{border:1px solid #cbd5e1;background:#ffffff;color:#1e293b}
body.light-mode th,body.light-mode td{border-bottom:1px solid #cbd5e1}
body.light-mode tr.active-set{background:#e2e8f0}
body.light-mode #infoPanel,body.light-mode #settingsPanel{background:#ffffff;border:1px solid #cbd5e1}
body.light-mode #led{background:#e2e8f0}
body.light-mode .btn.ghost{background:#ffffff;border:1px solid #cbd5e1;color:#1e293b}
body.light-mode button{background:#ffffff;border:1px solid #cbd5e1;color:#1e293b}

/* Light mode LED and beat indicators */
body.light-mode #led{background:#e2e8f0}
body.light-mode .beat-indicator{background:#e2e8f0;border:1px solid #cbd5e1}

/* Light mode toggle switches */
body.light-mode .slider{background-color:#cbd5e1}
body.light-mode .slider:before{background-color:#64748b}
body.light-mode input:checked + .slider{background-color:#3b82f6}
body.light-mode input:checked + .slider:before{background-color:#ffffff}

/* Toggle switch styles */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #2a3358;
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: #8b9bb4;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #7c9cff;
}

input:checked + .slider:before {
  transform: translateX(26px);
  background-color: #fff;
}

/* --- MOBILE FRIENDLY STYLES --- */
@media (max-width: 700px) {
  .card {
    width: 98vw;
    padding: 8px;
    border-radius: 0;
    min-width: unset;
  }
  h1 {
    flex-direction: column;
    gap: 8px;
    font-size: 1.3em;
  }
  .panel {
    padding: 8px;
    margin-top: 8px;
    border-radius: 10px;
  }
  .row {
    flex-direction: row !important;
    gap: 6px;
    margin-top: 4px;
    flex-wrap: wrap;
    width: 100%;
  }
  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }
  thead {
    display: none;
  }
  tr {
    margin-bottom: 10px;
    border-bottom: 1px solid #2a3358;
    background: none !important;
    border-radius: 8px;
  }
  td {
    text-align: left;
    padding: 6px 4px;
    border: none;
    font-size: 1em;
  }
  .settings-tabs {
    flex-direction: column;
    gap: 2px;
  }
  .settings-tab {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 2px;
    font-size: 1em;
    padding: 8px 0;
  }
  #settingsPanel, #infoPanel {
    width: 98vw !important;
    left: 1vw !important;
    right: unset !important;
    top: 10px !important;
    min-width: unset;
    max-width: 98vw;
    border-radius: 10px;
    padding: 10px;
  }
  input, select, button {
    font-size: 1em;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
  }
  label {
    width: 100%;
  }
  .toggle-switch {
    width: 40px;
    min-width: 40px;
    height: 22px;
  }
  .slider {
    min-width: 40px;
  }
  .slider:before {
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 3px;
  }
  .panel > div, .panel > label {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 8px !important;
  }
    /* Stack Sounds tab settings vertically on mobile */
    #soundsTab .setting-group {
      display: flex !important;
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 8px !important;
      width: auto !important;
    }
    #soundsTab label {
      display: flex !important;
      flex-direction: row !important;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      width: auto !important;
      margin-bottom: 0 !important;
      gap: 0 !important;
      text-align: left !important;
    }
    #soundsTab input[type="radio"],
    #soundsTab input[type="checkbox"] {
      align-self: center !important;
      margin-right: 0.1em !important;
      position: static;
      left: auto;
    }
    #soundsTab span {
      text-align: left !important;
      flex: none;
      margin: 0 !important;
    }
    #soundsTab .toggle-switch {
      margin-left: 0 !important;
    }
  #led {
    width: 40px !important;
    height: 40px !important;
  }
  #beatStrip {
    gap: 3px !important;
  }

  /* Center the tempo, subdivision, and time signature controls */
    .panel > .row[style*="margin-left:auto"],
    .panel > div > .row[style*="margin-left:auto"] {
      margin-left: 0 !important;
      justify-content: center !important;
      align-items: center !important;
      text-align: center;
      width: 100%;
      flex-direction: row !important;
      flex-wrap: wrap;
      gap: 6px;
    }
    .panel > .row[style*="margin-left:auto"] label,
    .panel > div > .row[style*="margin-left:auto"] label {
      align-items: center !important;
      width: auto;
      justify-content: center !important;
      text-align: center;
      margin-bottom: 0;
      flex: 1 1 0;
      min-width: 0;
    }
    .panel > .row[style*="margin-left:auto"] input,
    .panel > .row[style*="margin-left:auto"] select,
    .panel > div > .row[style*="margin-left:auto"] input,
    .panel > div > .row[style*="margin-left:auto"] select {
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      display: block;
      width: 70px;
      min-width: 0;
    }
}

/* Make buttons and inputs easier to tap */
button, input, select {
  touch-action: manipulation;
}

/* Prevent horizontal scroll */
html, body {
  max-width: 100vw;
  overflow-x: hidden;
}
</style>
</head>
<!-- I do declare that these are declarations of some random shit -->
<body>
  <img id="dvdLogo" src="other/DVD_logo.png" alt="DVD Logo">
  <div id="flashbangOverlay"></div>
  <!-- Tuner link top right -->
  <a href="https://open-met.org/tuner/" style="position:fixed;top:18px;right:24px;z-index:300;color:#7c9cff;text-decoration:none;font-size:1em;padding:8px 18px;border-radius:10px;background:#23284a;box-shadow:0 2px 8px #0003;transition:background 0.2s;display:inline-block;">Tuner</a>
  <div id="tennaVidContainer" style="position:fixed;top:10px;left:10px;z-index:500;display:none;pointer-events:none;">
    <video id="tennaVid" src="other/tenna.mp4" width="180" height="120" style="object-fit:contain;filter:drop-shadow(0 0 16px #23284a);" loop muted playsinline></video>
  </div>

    <!-- Markiplier image popup -->
    <div id="markiplierImgContainer" style="position:fixed;top:0;left:0;z-index:1000;display:none;pointer-events:auto;">
      <img id="markiplierImg" src="other/markiplier/markiplier1.jpg" style="width:240px;height:240px;object-fit:contain;box-shadow:0 2px 12px #0006;cursor:pointer;" alt="Markiplier" />
    </div>
  <div class="card">
    <h1>
      OpenMet
      <div style="display:flex;gap:8px;align-items:center">
        <span class="settings-icon" id="settingsIcon">⚙️</span>
      </div>
    </h1>

  <!-- Copyright and GitHub link bottom left -->
  <div style="position:fixed;bottom:10px;left:10px;z-index:100;font-size:13px;color:#8b9bb4;display:flex;align-items:center;gap:10px;">
  <!-- Usage Stats Display (above copyright) -->
  <div id="usageStats" style="position:fixed;bottom:38px;left:10px;z-index:101;font-size:15px;color:#8b9bb4;display:flex;gap:24px;align-items:center;justify-content:flex-start;"></div>
    <span>OpenMet v1.2.5 © 2025 by Slater Feistner</span>
    <a href="https://github.com/PossiblySlater/OpenMet" target="_blank" style="color:#7c9cff;text-decoration:none;display:flex;align-items:center;gap:4px;">
      <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
      <span>GitHub</span>
    </a>
  </div>

  <!-- Settings panel (Appearance, Audio, Sounds) -->
  <div id="settingsPanel">
    <span id="closeSettings">✖</span>
    <h2>Settings</h2>
    
    <!-- Settings Tabs -->
    <div class="settings-tabs">
      <button class="settings-tab active" id="appearanceTabBtn">Appearance</button>
      <button class="settings-tab" id="audioTabBtn">Audio</button>
      <button class="settings-tab" id="soundsTabBtn">Sounds</button>
      <button class="settings-tab" id="otherTabBtn">Other</button>
    </div>
    
    <!-- Appearance Tab -->
    <div class="setting-group settings-tab-content" id="appearanceTab" style="display:block">
      <h3>Appearance</h3>
      <label style="display:flex;flex-direction:column;gap:8px;margin:8px 0">
        <span>Theme</span>
        <select id="themeSelect" style="width:180px;padding:6px 10px;border-radius:8px;border:1px solid #2a3358;background:#0e1433;color:#fff">
          <option value="dark">Dark Mode</option>
          <option value="light">Light Mode</option>
          <option value="high-contrast">High Contrast</option>
          <option value="solarized-dark">Solarized Dark</option>
          <option value="solarized-light">Solarized Light</option>
          <option value="monochrome">Monochrome</option>
          <option value="pastel">Pastel</option>
          <option value="retro">Retro</option>
          <option value="ocean">Ocean</option>
          <option value="ultra-dark">Ultra-Dark</option>
        </select>
      </label>
    </div>
<style>
/* High Contrast mode styles
Idk why this is down here
i'm too lazy to move it */
body.high-contrast {
  background: #000 !important;
  color: #fff !important;
}
body.high-contrast .card {
  background: #000 !important;
  border: 2px solid #fff !important;
  color: #fff !important;
}
body.high-contrast .panel {
  background: #000 !important;
  border: 2px solid #fff !important;
  color: #fff !important;
}
body.high-contrast input, body.high-contrast select, body.high-contrast button {
  background: #000 !important;
  color: #fff !important;
  border: 2px solid #fff !important;
}
body.high-contrast th, body.high-contrast td {
  border-bottom: 2px solid #fff !important;
  color: #fff !important;
}
body.high-contrast tr.active-set {
  background: #222 !important;
}
body.high-contrast #infoPanel, body.high-contrast #settingsPanel {
  background: #000 !important;
  border: 2px solid #fff !important;
  color: #fff !important;
}
body.high-contrast #led {
  background: #fff !important;
}
body.high-contrast .btn.ghost {
  background: #000 !important;
  border: 2px solid #fff !important;
  color: #fff !important;
}
body.high-contrast button {
  background: #000 !important;
  border: 2px solid #fff !important;
  color: #fff !important;
}
body.high-contrast .settings-tab {
  background: #000 !important;
  color: #fff !important;
  border-bottom: 2px solid #fff !important;
}
body.high-contrast .settings-tab.active {
  background: #222 !important;
  color: #fff !important;
  border-bottom: 2px solid #fff !important;
}
/* Solarized Dark Theme */
body.solarized-dark {
  background: #002b36 !important;
  color: #839496 !important;
}
body.solarized-dark .card, body.solarized-dark .panel {
  background: #073642 !important;
  color: #839496 !important;
  border: 1px solid #586e75 !important;
}
body.solarized-dark input, body.solarized-dark select, body.solarized-dark button {
  background: #002b36 !important;
  color: #839496 !important;
  border: 1px solid #586e75 !important;
}
body.solarized-dark th, body.solarized-dark td {
  border-bottom: 1px solid #586e75 !important;
  color: #839496 !important;
}
body.solarized-dark .btn.ghost {
  background: #073642 !important;
  border: 1px solid #586e75 !important;
  color: #839496 !important;
}
body.solarized-dark #led {
  background: #b58900 !important;
}

/* Solarized Light Theme */
body.solarized-light {
  background: #fdf6e3 !important;
  color: #657b83 !important;
}
body.solarized-light .card, body.solarized-light .panel {
  background: #eee8d5 !important;
  color: #657b83 !important;
  border: 1px solid #93a1a1 !important;
}
body.solarized-light input, body.solarized-light select, body.solarized-light button {
  background: #fdf6e3 !important;
  color: #657b83 !important;
  border: 1px solid #93a1a1 !important;
}
body.solarized-light th, body.solarized-light td {
  border-bottom: 1px solid #93a1a1 !important;
  color: #657b83 !important;
}
body.solarized-light .btn.ghost {
  background: #eee8d5 !important;
  border: 1px solid #93a1a1 !important;
  color: #657b83 !important;
}
body.solarized-light #led {
  background: #b58900 !important;
}

/* Monochrome Theme */
body.monochrome {
  background: #222 !important;
  color: #eee !important;
}
body.monochrome .card, body.monochrome .panel {
  background: #333 !important;
  color: #eee !important;
  border: 1px solid #888 !important;
}
body.monochrome input, body.monochrome select, body.monochrome button {
  background: #222 !important;
  color: #eee !important;
  border: 1px solid #888 !important;
}
body.monochrome th, body.monochrome td {
  border-bottom: 1px solid #888 !important;
  color: #eee !important;
}
body.monochrome .btn.ghost {
  background: #333 !important;
  border: 1px solid #888 !important;
  color: #eee !important;
}
body.monochrome #led {
  background: #eee !important;
}

/* Pastel Theme */
body.pastel {
  background: #f7f3fa !important;
  color: #6c5b7b !important;
}
body.pastel .card, body.pastel .panel {
  background: #fceff9 !important;
  color: #6c5b7b !important;
  border: 1px solid #c8b6ff !important;
}
body.pastel input, body.pastel select, body.pastel button {
  background: #f7f3fa !important;
  color: #6c5b7b !important;
  border: 1px solid #c8b6ff !important;
}
body.pastel th, body.pastel td {
  border-bottom: 1px solid #c8b6ff !important;
  color: #6c5b7b !important;
}
body.pastel .btn.ghost {
  background: #fceff9 !important;
  border: 1px solid #c8b6ff !important;
  color: #6c5b7b !important;
}
body.pastel #led {
  background: #c8b6ff !important;
}

/* Retro Theme */
body.retro {
  background: #22223b !important;
  color: #f2e9e4 !important;
}
body.retro .card, body.retro .panel {
  background: #4a4e69 !important;
  color: #f2e9e4 !important;
  border: 2px solid #f2e9e4 !important;
}
body.retro input, body.retro select, body.retro button {
  background: #22223b !important;
  color: #f2e9e4 !important;
  border: 2px solid #f2e9e4 !important;
}
body.retro th, body.retro td {
  border-bottom: 2px solid #f2e9e4 !important;
  color: #f2e9e4 !important;
}
body.retro .btn.ghost {
  background: #4a4e69 !important;
  border: 2px solid #f2e9e4 !important;
  color: #f2e9e4 !important;
}
body.retro #led {
  background: #f2e9e4 !important;
}

/* Ocean Theme */
body.ocean {
  background: #0e2f44 !important;
  color: #a7e9e6 !important;
}
body.ocean .card, body.ocean .panel {
  background: #176582 !important;
  color: #a7e9e6 !important;
  border: 1px solid #3bb3c3 !important;
}
body.ocean input, body.ocean select, body.ocean button {
  background: #0e2f44 !important;
  color: #a7e9e6 !important;
  border: 1px solid #3bb3c3 !important;
}
body.ocean th, body.ocean td {
  border-bottom: 1px solid #3bb3c3 !important;
  color: #a7e9e6 !important;
}
body.ocean .btn.ghost {
  background: #176582 !important;
  border: 1px solid #3bb3c3 !important;
  color: #a7e9e6 !important;
}
body.ocean #led {
  background: #3bb3c3 !important;
}

/* Settings panel background for all themes */
body.solarized-dark #settingsPanel {
  background: #073642 !important;
  color: #839496 !important;
  border: 1px solid #586e75 !important;
}
body.solarized-light #settingsPanel {
  background: #eee8d5 !important;
  color: #657b83 !important;
  border: 1px solid #93a1a1 !important;
}
body.monochrome #settingsPanel {
  background: #333 !important;
  color: #eee !important;
  border: 1px solid #888 !important;
}
body.pastel #settingsPanel {
  background: #fceff9 !important;
  color: #6c5b7b !important;
  border: 1px solid #c8b6ff !important;
}
body.retro #settingsPanel {
  background: #4a4e69 !important;
  color: #f2e9e4 !important;
  border: 2px solid #f2e9e4 !important;
}
body.ocean #settingsPanel {
  background: #176582 !important;
  color: #a7e9e6 !important;
  border: 1px solid #3bb3c3 !important;
}
</style>
    <!-- Audio Tab -->
    <div class="settings-tab-content" id="audioTab" style="display:none">
      <div class="setting-group">
        <h3>Audio</h3>
        <label style="display:flex;flex-direction:column;gap:4px;margin:8px 0">
          <span>Main Beat Volume</span>
          <input type="range" id="mainVolume" min="0" max="100" value="80" style="width:200px">
          <span id="mainVolumeValue">80%</span>
        </label>
        <label style="display:flex;flex-direction:column;gap:4px;margin:8px 0">
          <span>Subdivision Volume</span>
          <input type="range" id="subVolume" min="0" max="100" value="60" style="width:200px">
          <span id="subVolumeValue">60%</span>
        </label>
      </div>
    </div>
    
    <!-- Sounds Tab -->
    <div class="settings-tab-content" id="soundsTab" style="display:none">
      <div class="setting-group">
        <h3>Metronome</h3>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
          <input type="radio" name="metronomeSound" id="metronomeDefault" value="default" checked>
          <span style="text-align:left">Default</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
          <input type="radio" name="metronomeSound" id="metronomeClick" value="click">
          <span style="text-align:left">Click</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
          <input type="radio" name="metronomeSound" id="metronomeClinician" value="clinician">
          <span style="text-align:left">Non-Trademark Infringing Clinician</span>
        </label>
      </div>
      <div class="setting-group" id="voicesGroup">
        <h3>Voice</h3>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <span style="text-align:left">Voice</span>
            <label class="toggle-switch">
              <input type="checkbox" id="voiceToggle">
              <span class="slider"></span>
            </label>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <input type="radio" name="voiceSound" id="voiceBrad" value="brad" checked>
            <span style="text-align:left">Brad</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <input type="radio" name="voiceSound" id="voiceGrandpa" value="grandpa">
            <span style="text-align:left">Grandpa</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <input type="radio" name="voiceSound" id="voiceSlater" value="slater">
            <span style="text-align:left">Slater</span>
          </label>
        </div>
      <div class="setting-group">
      </div>
    </div>

    <!-- Other Tab -->
    <div class="settings-tab-content" id="otherTab" style="display:none">
      <div class="setting-group">
        <h3>Other</h3>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
          <span>Left-Handed Mode</span>
          <label class="toggle-switch">
            <input type="checkbox" id="leftHandedToggle">
            <span class="slider"></span>
          </label>
        </label>
        <script>
// --- Microwave ---
let microwaveBuffer = "";
let microwaveTimeout = null;
let microwaveSpinTimeout = null;
let microwaveStopTimeout = null;
window.addEventListener('keydown', function(e) {
  if (typeof e.key === 'string' && e.key.length === 1) {
    microwaveBuffer += e.key.toLowerCase();
    if (microwaveBuffer.length > 20) microwaveBuffer = microwaveBuffer.slice(-20);
    if (microwaveBuffer.includes('microwave') && !microwaveTimeout) {
      const mwSound = document.getElementById('microwaveSound');
      if (mwSound) {
        mwSound.currentTime = 0;
        mwSound.play();
      }
      microwaveTimeout = setTimeout(() => {
        document.body.style.transition = '';
        document.body.style.transform = 'rotateY(0deg)';
        let spinStart = Date.now();
        let spinning = true;
        let stopped = false;
        let finalAngle = 0;
        function spinLoop() {
          if (!spinning || stopped) return;
          let elapsed = (Date.now() - spinStart) / 1000;
          let deg = (elapsed * 360 * (1/6)) % 360;
          finalAngle = deg;
          document.body.style.transition = '';
          document.body.style.transform = `rotateY(${deg}deg)`;
          if (elapsed < 31) {
            requestAnimationFrame(spinLoop);
          } else {
            spinning = false;
            stopped = true;
            microwaveTimeout = null;
            document.body.style.transition = '';
            document.body.style.transform = `rotateY(${finalAngle}deg)`;
          }
        }
        spinLoop();
      }, 7000);
    }
  }
});
// --- Usage Stats Tracking ---
function getTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function getStats() {
  let stats = JSON.parse(localStorage.getItem('openmet-usage-stats') || '{}');
  return stats;
}
function saveStats(stats) {
  localStorage.setItem('openmet-usage-stats', JSON.stringify(stats));
}
function updateUsageStatsUI() {
  const stats = getStats();
  const todayKey = getTodayKey();
  const todaySeconds = stats[todayKey] || 0;
  // Calculate streak
  let streak = 0;
  let d = new Date();
  for (let i = 0; i < 365; i++) {
    const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()-i}`;
    if (stats[key] && stats[key] > 0) {
      streak++;
    } else {
      break;
    }
  }
  const statsDiv = document.getElementById('usageStats');
  if (statsDiv) {
    statsDiv.innerHTML = `<b>Today's Active Time:</b> ${formatTime(todaySeconds)} <b>Daily Streak:</b> ${streak} day${streak===1?'':'s'}`;
  }
}
function formatTime(seconds) {
  const h = Math.floor(seconds/3600);
  const m = Math.floor((seconds%3600)/60);
  const s = seconds%60;
  return `${h>0?h+':':''}${(h>0&&m<10)?'0':''}${m}:${s<10?'0':''}${s}`;
}
let usageTimer = null, usageStart = null;
function startUsageTimer() {
  usageStart = Date.now();
  if (!usageTimer) {
    usageTimer = setInterval(()=>{
      const stats = getStats();
      const todayKey = getTodayKey();
      const now = Date.now();
      const elapsed = Math.floor((now-usageStart)/1000);
      stats[todayKey] = (stats[todayKey]||0) + 1;
      saveStats(stats);
      updateUsageStatsUI();
      usageStart = now;
    },1000);
  }
}
function stopUsageTimer() {
  if (usageTimer) {
    clearInterval(usageTimer);
    usageTimer = null;
  }
}
document.addEventListener('DOMContentLoaded', updateUsageStatsUI());
// --- DVD ---
let konamiSequence = ["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight"];
let konamiIndex = 0;
let dvdActive = false;
let dvdLogo = null;
let dvdX = 100, dvdY = 100, dvdVX = 2, dvdVY = 2;
let dvdToCorner = false;
let dvdCornerTarget = null;
function activateDVDMode() {
  dvdActive = true;
  dvdLogo = document.getElementById("dvdLogo");
  dvdLogo.style.display = "block";
  dvdX = Math.random() * (window.innerWidth - 120);
  dvdY = Math.random() * (window.innerHeight - 80);
  dvdVX = (Math.random() > 0.5 ? 2 : -2);
  dvdVY = (Math.random() > 0.5 ? 2 : -2);
  requestAnimationFrame(moveDVDLogo);
}
function moveToNearestCorner() {
  // Find nearest corner
  let corners = [
    {x:0, y:0},
    {x:0, y:window.innerHeight-80},
    {x:window.innerWidth-120, y:0},
    {x:window.innerWidth-120, y:window.innerHeight-80}
  ];
  let minDist = Infinity, target = null;
  for (let c of corners) {
    let dist = Math.hypot(dvdX-c.x, dvdY-c.y);
    if (dist < minDist) { minDist = dist; target = c; }
  }
  dvdCornerTarget = target;
  dvdToCorner = true;
}
function moveDVDLogo() {
  if (!dvdActive) return;
  if (dvdToCorner && dvdCornerTarget) {
    // Move directly toward the target corner
    let dx = dvdCornerTarget.x - dvdX;
    let dy = dvdCornerTarget.y - dvdY;
    let dist = Math.hypot(dx, dy);
    let speed = 6;
    if (dist < speed) {
      // Begin smooth return to center
      dvdReturnToCenter = true;
      dvdToCorner = false;
      dvdCornerTarget = null;
      dvdCenterTarget = { x: (window.innerWidth - 120) / 2, y: (window.innerHeight - 80) / 2 };
      // Play cheer sound
      const cheer = document.getElementById('cornerCheerSound');
      if (cheer) {
        cheer.currentTime = 0;
        cheer.play();
      }
  // Smoothly move to center if needed
  if (typeof dvdReturnToCenter !== 'undefined' && dvdReturnToCenter && dvdCenterTarget) {
    let dx = dvdCenterTarget.x - dvdX;
    let dy = dvdCenterTarget.y - dvdY;
    let dist = Math.hypot(dx, dy);
    let speed = 4;
    if (dist < speed) {
      dvdX = dvdCenterTarget.x;
      dvdY = dvdCenterTarget.y;
      dvdReturnToCenter = false;
      dvdCenterTarget = null;
      // Resume bouncing with random velocity
      function randomNonZeroSpeed() {
        let s = 2 + Math.random() * 3;
        return Math.random() > 0.5 ? s : -s;
      }
      dvdVX = randomNonZeroSpeed();
      dvdVY = randomNonZeroSpeed();
      if (Math.abs(dvdVX) < 1) dvdVX = dvdVX > 0 ? 2 : -2;
      if (Math.abs(dvdVY) < 1) dvdVY = dvdVY > 0 ? 2 : -2;
    } else {
      dvdX += (dx/dist)*speed;
      dvdY += (dy/dist)*speed;
    }
    dvdLogo.style.left = dvdX + "px";
    dvdLogo.style.top = dvdY + "px";
    requestAnimationFrame(moveDVDLogo);
    return;
  }
    } else {
      dvdX += (dx/dist)*speed;
      dvdY += (dy/dist)*speed;
    }
  } else {
    dvdX += dvdVX;
    dvdY += dvdVY;
    let hitCorner = false;
    // Check for corner hit
    if ((dvdX <= 0 && dvdY <= 0) ||
        (dvdX <= 0 && dvdY >= window.innerHeight - 80) ||
        (dvdX >= window.innerWidth - 120 && dvdY <= 0) ||
        (dvdX >= window.innerWidth - 120 && dvdY >= window.innerHeight - 80)) {
      hitCorner = true;
    }
    if (dvdX <= 0 || dvdX >= window.innerWidth - 120) dvdVX *= -1;
    if (dvdY <= 0 || dvdY >= window.innerHeight - 80) dvdVY *= -1;
    if (hitCorner) {
      const cheer = document.getElementById('cornerCheerSound');
      if (cheer) {
        cheer.currentTime = 0;
        cheer.play();
      }
    }
  }
  dvdLogo.style.left = dvdX + "px";
  dvdLogo.style.top = dvdY + "px";
  requestAnimationFrame(moveDVDLogo);
}
window.addEventListener("keydown", function(e) {
  if (e.key === konamiSequence[konamiIndex]) {
    konamiIndex++;
    if (konamiIndex === konamiSequence.length) {
      if (!dvdActive) {
        activateDVDMode();
      } else {
        moveToNearestCorner();
      }
      konamiIndex = 0;
    }
  } else {
    konamiIndex = 0;
  }
});
        document.addEventListener('DOMContentLoaded', function() {
          var leftHandedToggle = document.getElementById('leftHandedToggle');
          leftHandedToggle.addEventListener('change', function() {
            if (leftHandedToggle.checked) {
              document.body.style.transform = 'scaleX(-1)';
            } else {
              document.body.style.transform = '';
            }
          });
        });
        </script>
      </div>
    </div>
  </div>

  <!-- LED and beat strip -->
  <div class="panel">
    <div style="display:flex;gap:20px;align-items:center">
  <div id="led" style="width:60px;height:60px;border-radius:50%"></div>
      <div id="beatStrip" style="display:flex;gap:6px;flex:1"></div>
    </div>
  </div>

  <!-- Controls: Start/Stop, Export/Import, Tempo, Subdivision, Time Signature -->
  <div class="panel">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <!-- Left: Start/Stop/Export/Import -->
      <div class="row">
        <button id="toggleBtn" class="btn primary" title="Start/Stop">▶</button>
        <button id="exportBtn" class="btn success" title="Export Sets">📤</button>
        <input type="file" id="importFile" style="display:none">
        <button id="importBtn" class="btn ghost" title="Import Sets">📥</button>
      </div>

      <!-- Right: Tempo / TS -->
      <div class="row" style="margin-left:auto;gap:6px;align-items:center">
        <label style="margin:0;display:flex;flex-direction:column;align-items:flex-start">
          BPM
          <input id="setBpm" type="number" min="20" max="300" value="120" style="width:70px">
        </label>

        <label style="margin:0;display:flex;flex-direction:column;align-items:flex-start">
          Subdivision
          <select id="subdivision" style="width:70px">
            <option value="1">None</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
          </select>
        </label>

        <label style="margin:0;display:flex;flex-direction:column;align-items:flex-start">
          <input id="setTop" type="number" min="1" max="12" value="4" style="width:50px;text-align:center">
          <div style="width:25px;height:1px;background:#e8ebff;margin:2px auto"></div>
          <select id="setBottom" style="width:70px;text-align:center">
            <option value="1">1</option><option value="2">2</option>
            <option value="4" selected>4</option><option value="8">8</option><option value="16">16</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <!-- Sets programming: Group name, sets table, add set, toggles -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
      <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
        Group Name
        <input id="groupName" type="text" placeholder="Enter group name" style="width:200px">
      </label>
      
      <div style="display:flex;gap:8px;align-items:flex-end">
        <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
          Set Name
          <input id="setName" type="text" placeholder="Enter set name" style="width:120px">
        </label>
        <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
          Measures
          <input id="setMeasures" type="number" min="1" value="4" style="width:60px">
        </label>
        <button id="addSetBtn" class="btn success" title="Add Set">➕</button>
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <span style="font-size:14px">Use Sets</span>
          <label class="toggle-switch">
            <input type="checkbox" id="useSetsToggle">
            <span class="slider"></span>
          </label>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <span style="font-size:14px">Loop</span>
          <label class="toggle-switch">
            <input type="checkbox" id="loopToggle">
            <span class="slider"></span>
          </label>
        </label>
      </div>
    </div>
    <h3>Program Sets</h3>
    
    <!-- Search and Filter Controls -->
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
      <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
        <span style="font-size:14px;margin-bottom:4px">Search Sets</span>
        <input id="setSearch" type="text" placeholder="Search by name, BPM, or time signature..." style="width:250px">
      </label>
      <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
        <span style="font-size:14px;margin-bottom:4px">Filter by BPM</span>
        <select id="bpmFilter" style="width:120px">
          <option value="">All BPMs</option>
          <option value="slow">Slow (60-90)</option>
          <option value="medium">Medium (90-140)</option>
          <option value="fast">Fast (140+)</option>
        </select>
      </label>
      <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
        <span style="font-size:14px;margin-bottom:4px">Sort by</span>
        <select id="sortBy" style="width:120px">
          <option value="order">Order</option>
          <option value="name">Name</option>
          <option value="bpm">BPM</option>
          <option value="measures">Measures</option>
        </select>
      </label>
      <button id="clearFilters" class="btn ghost" style="margin-top:20px">Clear</button>
    </div>
    
    <table>
      <thead><tr><th>#</th><th>Start</th><th>End</th><th>Set Name</th><th>BPM</th><th>TS</th><th>Measures</th><th>Actions</th></tr></thead>
      <tbody id="setTable"></tbody>
    </table>
  </div>
</div>

<!-- Hidden audio elements for voice counting -->
<div id="voice-audio" style="display:none">
  <!-- Grandpa -->
  <audio id="grandpaVoice1" src="Voices/Grandpa/1.mp3"></audio>
  <audio id="grandpaVoice2" src="Voices/Grandpa/2.mp3"></audio>
  <audio id="grandpaVoice3" src="Voices/Grandpa/3.mp3"></audio>
  <audio id="grandpaVoice4" src="Voices/Grandpa/4.mp3"></audio>
  <audio id="grandpaVoice5" src="Voices/Grandpa/5.mp3"></audio>
  <audio id="grandpaVoice6" src="Voices/Grandpa/6.mp3"></audio>
  <audio id="grandpaVoice7" src="Voices/Grandpa/7.mp3"></audio>
  <audio id="grandpaVoice8" src="Voices/Grandpa/8.mp3"></audio>
  <audio id="grandpaVoice9" src="Voices/Grandpa/9.mp3"></audio>
  <audio id="grandpaVoice10" src="Voices/Grandpa/10.mp3"></audio>
  <audio id="grandpaVoice11" src="Voices/Grandpa/11.mp3"></audio>
  <audio id="grandpaVoice12" src="Voices/Grandpa/12.mp3"></audio>
  <!-- Slater -->
  <audio id="slaterVoice1" src="Voices/Slater/1.mp3"></audio>
  <audio id="slaterVoice2" src="Voices/Slater/2.mp3"></audio>
  <audio id="slaterVoice3" src="Voices/Slater/3.mp3"></audio>
  <audio id="slaterVoice4" src="Voices/Slater/4.mp3"></audio>
  <audio id="slaterVoice5" src="Voices/Slater/5.mp3"></audio>
  <audio id="slaterVoice6" src="Voices/Slater/6.mp3"></audio>
  <audio id="slaterVoice7" src="Voices/Slater/7.mp3"></audio>
  <audio id="slaterVoice8" src="Voices/Slater/8.mp3"></audio>
  <audio id="slaterVoice9" src="Voices/Slater/9.mp3"></audio>
  <audio id="slaterVoice10" src="Voices/Slater/10.mp3"></audio>
  <audio id="slaterVoice11" src="Voices/Slater/11.mp3"></audio>
  <audio id="slaterVoice12" src="Voices/Slater/12.mp3"></audio>
  <!-- Brad -->
  <audio id="bradVoice1" src="Voices/Brad/1.mp3"></audio>
  <audio id="bradVoice2" src="Voices/Brad/2.mp3"></audio>
  <audio id="bradVoice3" src="Voices/Brad/3.mp3"></audio>
  <audio id="bradVoice4" src="Voices/Brad/4.mp3"></audio>
  <audio id="bradVoice5" src="Voices/Brad/5.mp3"></audio>
  <audio id="bradVoice6" src="Voices/Brad/6.mp3"></audio>
  <audio id="bradVoice7" src="Voices/Brad/7.mp3"></audio>
  <audio id="bradVoice8" src="Voices/Brad/8.mp3"></audio>
  <audio id="bradVoice9" src="Voices/Brad/9.mp3"></audio>
  <audio id="bradVoice10" src="Voices/Brad/10.mp3"></audio>
  <audio id="bradVoice11" src="Voices/Brad/11.mp3"></audio>
  <audio id="bradVoice12" src="Voices/Brad/12.mp3"></audio>
</div>

<!-- DR mode quote display and input -->
<div id="drQuote" style="display:none;position:fixed;bottom:10px;right:10px;z-index:100;font-size:13px;color:#f87171;display:flex;align-items:center;gap:10px;background:none;padding:0;box-shadow:none;border-radius:0;cursor:pointer;pointer-events:auto;text-align:right;line-height:1.4" title="Click for a new quote"></div>
<textarea id="drQuotesInput" style="display:none;">
Stop Everything - Kris Get The Banana
Coming Straight From Your House!
REBUILD MY KIDS!
THAT'S RIGHT! NOW'S YOUR CHANCE TO BE A [[Big Shot]]
HEY EVERY    !
1997 KROMER
SELECT THE HEAD THAT YOU PREFER
EV3RY  BUDDY  'S FAVORITE ((Number 1 Rated Salesman1997))
 [Hyperlink Blocked] 
Potassium
Wasn't that quiz just oodles of fun, folks!?
Just look at that Fun-o-meter!!! Haha!!!
Fresh from the Juice, Fresh from the Juice!
IT'S! TV! TIME!
He's groovy - and never glooby!
You love TV... don't you?
LIGHT nER! HEY-HE Y HEY!!!
LOOKS LIKE YOU'RE [[All Alone On A Late Night?]]
LIVING IN A GODDAMN GARBAGE CAN???
WELL HAVE I GOT A [[Specil Deal]] FOR LONELY [[Hearts]] LIKE YOU!!
WHY BE THE [[Little Sponge]] WHO HATES ITS [[$4.99]] LIFE
[[BIG SHOT!!!!!]]
YOU WANT IT. YOU WANT [[Hyperlink Blocked]], DON'T YOU.
Ah My Sweet Idiot Children
(Sort Of Regal Mostly Cruel Laughter)
Oh I Wonder (I Actually Know The Answer)
Seems That You Failed To Notice - The Giant Freaking Robot In The Middle Of My Palace
You Are Definitely Going To Kick: My Ass
Oh No What That
Imagine Poor Noelle Clipping Into A Wall Somewhere. Wasting Away From Potassium Deficiency
Now That We Are Trucies I Feel Like We Are On the Same... Mathematical Wavelength
Ok There's Nothing Wrong With Him He's Just Annoying
I Only Play Mobile Games
Berdly gives the secret sign! But Queen is busy with a coloring book!
Bro That’s Weird But Ok
Hey Chat Does Anyone Know What Happened To That Stuff
You Wanna Fight, Loser?
I Have No Time For Such Frivolitites (And Would Kick Your Ass) 
Teens Are Merely Big Children (And Adults Are Bigger Children) 
I Only Have Like 4 Cages
Whoops That Was My Extra Dangerous Glass
I'm So Distracted Right Now
Running Laughing Protocol - Ha Ha Ha Ha Ha Ha Ha Ha Ha Ha Ha
No I Am A Computer (Smart)
(I Have No Damn Clue Just Go With It)
I Did Not Ask Him I Did Not Ask Him I Did Not Ask Him I Did Not Ask Him I Did Not Ask Him
Honk Honk No It’s Just The Sounds Of The City
I'm Just A Computer I Dont Know Everything LMAO
Oooo Ouchie Mama
Oh Damn I Did Not Know That
Lightners Love Traffic They Look It Up All The Time
Self-Esteem Crushing Efficiency 300% And Rising
Don't Worry That Was My Throwing Glass It's Safe
I've Had Like 4 Of These All-Ages Appropriate Glasses Of Pure Battery Acid
Get A Load Of The Guy With No Meat Or Fruit In His Castle Walls
Oh My Circuits Kris Get In The Car
Wow, what an AMAZING performance!
And get me a cup of coffee.
Sorry kids, no falling rocks today.
WHAT THE...!? HOW THE WHAT THE MAMA WHAT THE HECK THE WOH WOAH WOH HECK HECK WHAT THE
COWABUNGA-DERO! THAT'S THE SMOOTH TASTE OF TV TIME!
Sick of the CLASSICS? We'll make 'em NEO! NEO shows, NEO programs, just watch, watch, WATCH!
CHAOS, CHAOS!
I Just Want To Make Everyone Smile And If I Become An Evil Villain To Accomplish That Is That Bad?
Go play minecrap or something!
</textarea>

<script>
// UI ELEMENT REFERENCES
// Collects all main UI elements for easy access throughout the script.
document.addEventListener('DOMContentLoaded', () => {
  // This block runs after the DOM is loaded and sets up mobile UI, Markiplier popup, and event listeners.
  // Hide voice options on mobile devices for cleaner UI (still accessible in DOM for JS logic)
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if (isMobile) {
    const voicesGroup = document.getElementById('voicesGroup');
    if (voicesGroup) voicesGroup.style.display = 'none';
  }

  // Markiplier image popup logic
  // Detects rapid clicks in the top-left corner and displays a cycling Markiplier image permanently until reload.
  // Tracks timestamps of clicks in the top-left corner for spam detection
  let topLeftSpamTimestamps = [];
  // Markiplier image container and image element
  const markiplierImgContainer = document.getElementById('markiplierImgContainer');
  const markiplierImg = document.getElementById('markiplierImg');
  // Array of Markiplier image paths (jpg/gif)
  const markiplierImages = [
  'other/markiplier/markiplier1.jpg',
  'other/markiplier/markiplier2.gif',
  'other/markiplier/markiplier4.gif',
  'other/markiplier/markiplier5.gif'
  ];
  // Current Markiplier image index and activation flag
  let markiplierIndex = 0;
  let markiplierActive = false;

  // Listen for mouse clicks in the top-left corner (within 40px of top/left)
  // If spammed rapidly, show Markiplier image permanently
  document.addEventListener('mousedown', function(e) {
    if (!markiplierActive && e.clientX < 40 && e.clientY < 40) {
      const now = Date.now();
      topLeftSpamTimestamps.push(now);
      // Only keep timestamps from the last 2 seconds
      topLeftSpamTimestamps = topLeftSpamTimestamps.filter(t => now - t < 2000);
      if (topLeftSpamTimestamps.length > 5) {
        // Show Markiplier image and keep it visible until reload
        markiplierImgContainer.style.display = 'block';
        markiplierImg.src = markiplierImages[markiplierIndex];
        markiplierImgContainer.style.opacity = '1';
        markiplierActive = true;
      }
    }
  });

  // Clicking the Markiplier image cycles through the available images
  if (markiplierImg) {
    markiplierImg.onclick = function(e) {
      markiplierIndex = (markiplierIndex + 1) % markiplierImages.length;
      markiplierImg.src = markiplierImages[markiplierIndex];
    };
  }
});
// Main UI element references
const els = {
  led: document.getElementById("led"),
  beatStrip: document.getElementById("beatStrip"),
  toggleBtn: document.getElementById("toggleBtn"),
  setBpm: document.getElementById("setBpm"),
  setTop: document.getElementById("setTop"),
  setBottom: document.getElementById("setBottom"),
  setMeasures: document.getElementById("setMeasures"),
  subdivision: document.getElementById("subdivision"),
  setName: document.getElementById("setName"),
  addSetBtn: document.getElementById("addSetBtn"),
  setTable: document.getElementById("setTable"),
  exportBtn: document.getElementById("exportBtn"),
  importBtn: document.getElementById("importBtn"),
  importFile: document.getElementById("importFile"),
  useSetsToggle: document.getElementById("useSetsToggle"),
  loopToggle: document.getElementById("loopToggle"),
  groupName: document.getElementById("groupName"),
  infoIcon: document.getElementById("infoIcon"),
  infoPanel: document.getElementById("infoPanel"),
  closeInfo: document.getElementById("closeInfo"),
  settingsIcon: document.getElementById("settingsIcon"),
  settingsPanel: document.getElementById("settingsPanel"),
  closeSettings: document.getElementById("closeSettings"),
  lightModeToggle: document.getElementById("lightModeToggle"),
  mainVolume: document.getElementById("mainVolume"),
  subVolume: document.getElementById("subVolume"),
  mainVolumeValue: document.getElementById("mainVolumeValue"),
  subVolumeValue: document.getElementById("subVolumeValue"),
  voiceToggle: document.getElementById("voiceToggle") || {},
  voiceBrad: document.getElementById("voiceBrad") || {},
  voiceGrandpa: document.getElementById("voiceGrandpa") || {},
  voiceSlater: document.getElementById("voiceSlater") || {},
};

// APPLICATION STATE
// Stores all runtime state for metronome, sets, and audio

let state = {
  sets: [],
  currentSetIndex: 0,
  beatIndex: 0,
  measureIndex: 0,
  isRunning: false,
  bpm: 120,
  beatsPerBar: 4,
  beatUnit: 4,
  subdivision: 1,
  mainVolume: 0.8,
  subVolume: 0.6,
  audioCtx: null,
  nextNoteTime: 0,
  lookahead: 25,
  scheduleAheadTime: 0.1,
  schedulerId: null,
  currentSet: null,
  beatStates: [], // 0 = off, 1 = normal, 2 = accented
  startSetIndex: 0,
  endSetIndex: 0,
  // Filter and search state
  searchTerm: "",
  bpmFilter: "",
  sortBy: "order",
  filteredSets: [],
  // Metronome sound selection
  metronomeSound: "default",
  // Voice AudioBuffers
  voiceBuffers: {
    brad: {},
    grandpa: {},
    slater: {}
  }
};

// SETTINGS PANEL LOGIC
// Preload all voice audio files into AudioBuffers for sample-accurate playback
async function preloadVoiceBuffers() {
  if (!state.audioCtx) return;
  const voices = ['brad', 'grandpa', 'slater'];
  const maxClips = 12;
  for (const voice of voices) {
    for (let i = 1; i <= maxClips; i++) {
      const url = `Voices/${voice.charAt(0).toUpperCase() + voice.slice(1)}/${i}.mp3`;
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await state.audioCtx.decodeAudioData(arrayBuffer);
        state.voiceBuffers[voice][i] = audioBuffer;
      } catch (e) {
        // File may not exist, skip
      }
    }
  }
}
// Show/hide settings panel
els.settingsIcon.onclick = ()=> els.settingsPanel.style.display="block";
els.closeSettings.onclick = ()=> els.settingsPanel.style.display="none";

// SETTINGS FUNCTIONALITY
// Theme selection logic
const themeSelect = document.getElementById('themeSelect');
function applyTheme(theme) {
  // Helper to set button icons
  function setButtonIcons(show) {
    els.toggleBtn.textContent = show ? (state.isRunning ? "⏹" : "▶") : "";
    els.exportBtn.textContent = show ? "📤" : "";
    els.importBtn.textContent = show ? "📥" : "";
    els.addSetBtn.textContent = show ? "➕" : "";
  }
  // Update theme dropdown style to match theme
  if (themeSelect) {
    themeSelect.style.background = '';
    themeSelect.style.color = '';
    themeSelect.style.border = '';
    switch (theme) {
      case 'light':
        themeSelect.style.background = '#fff';
        themeSelect.style.color = '#1e293b';
        themeSelect.style.border = '1px solid #cbd5e1';
        break;
      case 'high-contrast':
        themeSelect.style.background = '#000';
        themeSelect.style.color = '#fff';
        themeSelect.style.border = '2px solid #fff';
        break;
      case 'solarized-dark':
        themeSelect.style.background = '#002b36';
        themeSelect.style.color = '#839496';
        themeSelect.style.border = '1px solid #586e75';
        break;
      case 'solarized-light':
        themeSelect.style.background = '#fdf6e3';
        themeSelect.style.color = '#657b83';
        themeSelect.style.border = '1px solid #93a1a1';
        break;
      case 'monochrome':
        themeSelect.style.background = '#222';
        themeSelect.style.color = '#eee';
        themeSelect.style.border = '1px solid #888';
        break;
      case 'pastel':
        themeSelect.style.background = '#f7f3fa';
        themeSelect.style.color = '#6c5b7b';
        themeSelect.style.border = '1px solid #c8b6ff';
        break;
      case 'retro':
        themeSelect.style.background = '#22223b';
        themeSelect.style.color = '#f2e9e4';
        themeSelect.style.border = '2px solid #f2e9e4';
        break;
      case 'ocean':
        themeSelect.style.background = '#0e2f44';
        themeSelect.style.color = '#a7e9e6';
        themeSelect.style.border = '1px solid #3bb3c3';
        break;
      case 'ultra-dark':
        themeSelect.style.background = '#000';
        themeSelect.style.color = '#000';
        themeSelect.style.border = '1px solid #000';
        break;
      default:
        themeSelect.style.background = '#0e1433';
        themeSelect.style.color = '#fff';
        themeSelect.style.border = '1px solid #2a3358';
    }
  }
  // Update theme dropdown style to match theme
  if (themeSelect) {
    themeSelect.style.background = '';
    themeSelect.style.color = '';
    themeSelect.style.border = '';
    if (theme === 'light') {
      themeSelect.style.background = '#fff';
      themeSelect.style.color = '#1e293b';
      themeSelect.style.border = '1px solid #cbd5e1';
    } else if (theme === 'high-contrast') {
      themeSelect.style.background = '#000';
      themeSelect.style.color = '#fff';
      themeSelect.style.border = '2px solid #fff';
    } else {
      themeSelect.style.background = '#0e1433';
      themeSelect.style.color = '#fff';
      themeSelect.style.border = '1px solid #2a3358';
    }
  }
  // Remove all theme classes
  document.body.classList.remove(
    'light-mode', 'high-contrast', 'solarized-dark', 'solarized-light', 'monochrome', 'pastel', 'retro', 'ocean', 'ultra-dark'
  );
  if (theme === 'light') {
    setButtonIcons(true);
    // Play flashbang effect for light modes
    const overlay = document.getElementById('flashbangOverlay');
    const sound = document.getElementById('flashbangSound');
    overlay.classList.add('active');
    overlay.style.opacity = '1';
    overlay.style.filter = 'blur(8px)';
    if (sound) {
      sound.currentTime = 0;
      sound.play();
    }
    setTimeout(() => {
      overlay.style.transition = 'opacity 2s, filter 2s';
      overlay.style.opacity = '0';
      overlay.style.filter = 'blur(0px)';
      setTimeout(() => {
        overlay.classList.remove('active');
        overlay.style.transition = '';
      }, 2000);
    }, 1200);
    document.body.classList.add('light-mode');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'dark') {
    setButtonIcons(true);
    // Default dark mode (no extra class)
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'ultra-dark') {
    setButtonIcons(false);
    document.body.classList.add('ultra-dark');
    // Play powerdown.mp3
    const powerdown = document.getElementById('powerdownSound');
    if (powerdown) {
      powerdown.currentTime = 0;
      powerdown.play();
    }
    // Stop the metronome
    if (state.isRunning && typeof stop === 'function') {
      stop();
    }
    // Do NOT save theme locally you piece of shit
  } else if (theme === 'high-contrast') {
    setButtonIcons(true);
    document.body.classList.add('high-contrast');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'solarized-dark') {
    setButtonIcons(true);
    document.body.classList.add('solarized-dark');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'solarized-light') {
    setButtonIcons(true);
    const overlay = document.getElementById('flashbangOverlay');
    const sound = document.getElementById('flashbangSound');
    overlay.classList.add('active');
    overlay.style.opacity = '1';
    overlay.style.filter = 'blur(8px)';
    if (sound) {
      sound.currentTime = 0;
      sound.play();
    }
    setTimeout(() => {
      overlay.style.transition = 'opacity 2s, filter 2s';
      overlay.style.opacity = '0';
      overlay.style.filter = 'blur(0px)';
      setTimeout(() => {
        overlay.classList.remove('active');
        overlay.style.transition = '';
      }, 2000);
    }, 1200);
    document.body.classList.add('solarized-light');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'monochrome') {
    setButtonIcons(true);
    document.body.classList.add('monochrome');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'pastel') {
    setButtonIcons(true);
    const overlay = document.getElementById('flashbangOverlay');
    const sound = document.getElementById('flashbangSound');
    overlay.classList.add('active');
    overlay.style.opacity = '1';
    overlay.style.filter = 'blur(8px)';
    if (sound) {
      sound.currentTime = 0;
      sound.play();
    }
    setTimeout(() => {
      overlay.style.transition = 'opacity 2s, filter 2s';
      overlay.style.opacity = '0';
      overlay.style.filter = 'blur(0px)';
      setTimeout(() => {
        overlay.classList.remove('active');
        overlay.style.transition = '';
      }, 2000);
    }, 1200);
    document.body.classList.add('pastel');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'retro') {
    setButtonIcons(true);
    document.body.classList.add('retro');
    localStorage.setItem('openmet-theme', theme);
  } else if (theme === 'ocean') {
    setButtonIcons(true);
    document.body.classList.add('ocean');
    localStorage.setItem('openmet-theme', theme);
  }
  renderBeatStrip();
}
if (themeSelect) {
  themeSelect.onchange = function() {
    applyTheme(themeSelect.value);
  };
}
// On page load, apply saved theme
const savedTheme = localStorage.getItem('openmet-theme') || 'dark';
if (themeSelect) themeSelect.value = savedTheme;
applyTheme(savedTheme);

// Volume sliders
// Update main beat volume and save to localStorage
els.mainVolume.oninput = () => {
  const value = els.mainVolume.value;
  els.mainVolumeValue.textContent = value + "%";
  state.mainVolume = value / 100;
  localStorage.setItem('openmet-main-volume', value);
};

// Update subdivision volume and save to localStorage
els.subVolume.oninput = () => {
  const value = els.subVolume.value;
  els.subVolumeValue.textContent = value + "%";
  state.subVolume = value / 100;
  localStorage.setItem('openmet-sub-volume', value);
};

// SETTINGS TABS LOGIC
// Tab button references for settings panel
const tabBtns = {
  appearance: document.getElementById("appearanceTabBtn"),
  audio: document.getElementById("audioTabBtn"),
  sounds: document.getElementById("soundsTabBtn"),
  other: document.getElementById("otherTabBtn")
};
// Tab content references for settings panel
const tabContents = {
  appearance: document.getElementById("appearanceTab"),
  audio: document.getElementById("audioTab"),
  sounds: document.getElementById("soundsTab"),
  other: document.getElementById("otherTab")
};
// Show the selected settings tab and hide others
function showTab(tab) {
  for (const key in tabBtns) {
    tabBtns[key].classList.toggle("active", key === tab);
    tabContents[key].style.display = key === tab ? "block" : "none";
  }
}
tabBtns.appearance.onclick = () => showTab("appearance");
tabBtns.audio.onclick = () => showTab("audio");
tabBtns.sounds.onclick = () => showTab("sounds");
tabBtns.other.onclick = () => showTab("other");

// SETS MANAGEMENT
// Render the sets table in the UI
function renderSets(){
  // Apply filters and render
  applyFilters();
}
// Remove a set from the list and update indices
function removeSet(i){ 
  state.sets.splice(i,1); 
  
  // Adjust start/end indices if needed
  if (state.startSetIndex >= state.sets.length) {
    state.startSetIndex = Math.max(0, state.sets.length - 1);
  }
  if (state.endSetIndex >= state.sets.length) {
    state.endSetIndex = Math.max(0, state.sets.length - 1);
  }
  
  renderSets(); 
}

// Duplicate a set
function duplicateSet(i) {
  if (i >= 0 && i < state.sets.length) {
    const originalSet = state.sets[i];
    const duplicatedSet = {
      name: originalSet.name + " (Copy)",
      bpm: originalSet.bpm,
      top: originalSet.top,
      bottom: originalSet.bottom,
      measures: originalSet.measures,
      subdivision: originalSet.subdivision,
      beatStates: originalSet.beatStates ? [...originalSet.beatStates] : []
    };
    
    // Insert the duplicate after the original set
    state.sets.splice(i + 1, 0, duplicatedSet);
    
    // Update end set index if needed
    if (state.endSetIndex >= i) {
      state.endSetIndex++;
    }
    
    renderSets();
  }
}

// Move a set up in the list
function moveSetUp(i) {
  if (i > 0 && i < state.sets.length) {
    // Swap with previous set
    const temp = state.sets[i];
    state.sets[i] = state.sets[i - 1];
    state.sets[i - 1] = temp;
    
    // Update indices
    if (state.startSetIndex === i) {
      state.startSetIndex = i - 1;
    } else if (state.startSetIndex === i - 1) {
      state.startSetIndex = i;
    }
    
    if (state.endSetIndex === i) {
      state.endSetIndex = i - 1;
    } else if (state.endSetIndex === i - 1) {
      state.endSetIndex = i;
    }
    
    if (state.currentSetIndex === i) {
      state.currentSetIndex = i - 1;
    } else if (state.currentSetIndex === i - 1) {
      state.currentSetIndex = i;
    }
    
    renderSets();
  }
}

// Move a set down in the list
function moveSetDown(i) {
  if (i >= 0 && i < state.sets.length - 1) {
    // Swap with next set
    const temp = state.sets[i];
    state.sets[i] = state.sets[i + 1];
    state.sets[i + 1] = temp;
    
    // Update indices
    if (state.startSetIndex === i) {
      state.startSetIndex = i + 1;
    } else if (state.startSetIndex === i + 1) {
      state.startSetIndex = i;
    }
    
    if (state.endSetIndex === i) {
      state.endSetIndex = i + 1;
    } else if (state.endSetIndex === i + 1) {
      state.endSetIndex = i;
    }
    
    if (state.currentSetIndex === i) {
      state.currentSetIndex = i + 1;
    } else if (state.currentSetIndex === i + 1) {
      state.currentSetIndex = i;
    }
    
    renderSets();
  }
}

// SEARCH AND FILTER FUNCTIONALITY
// Apply search and filter to sets
function applyFilters() {
  let filtered = [...state.sets];
  
  // Apply search filter
  if (state.searchTerm) {
    const searchLower = state.searchTerm.toLowerCase();
    filtered = filtered.filter(set => 
      set.name.toLowerCase().includes(searchLower) ||
      set.bpm.toString().includes(searchLower) ||
      `${set.top}/${set.bottom}`.includes(searchLower)
    );
  }
  
  // Apply BPM filter
  if (state.bpmFilter) {
    filtered = filtered.filter(set => {
      switch (state.bpmFilter) {
        case 'slow': return set.bpm >= 60 && set.bpm <= 90;
        case 'medium': return set.bpm > 90 && set.bpm <= 140;
        case 'fast': return set.bpm > 140;
        default: return true;
      }
    });
  }
  
  // Apply sorting
  filtered.sort((a, b) => {
    switch (state.sortBy) {
      case 'name':
        return a.name.localeCompare(b.name);
      case 'bpm':
        return a.bpm - b.bpm;
      case 'measures':
        return a.measures - b.measures;
      case 'order':
      default:
        // Maintain original order by finding original indices
        const indexA = state.sets.findIndex(s => s === a);
        const indexB = state.sets.findIndex(s => s === b);
        return indexA - indexB;
    }
  });
  
  state.filteredSets = filtered;
  renderFilteredSets();
}

// Render filtered sets
function renderFilteredSets() {
  els.setTable.innerHTML = "";
  state.filteredSets.forEach((s, i) => {
    // Find original index for proper functionality
    const originalIndex = state.sets.findIndex(set => set === s);
    
    const row = document.createElement("tr");
    // Only highlight if metronome is running, using sets, and this is the current set
    if(state.currentSetIndex === originalIndex && state.isRunning && els.useSetsToggle.checked){
      row.classList.add("active-set");
      row.style.background = "#1b2347";
      row.style.border = "2px solid #7c9cff";
    } else {
      // Reset to default styling when not highlighted
      row.style.background = "";
      row.style.border = "";
    }
    row.innerHTML = `<td>${originalIndex + 1}</td>
      <td><input type="checkbox" ${originalIndex === state.startSetIndex ? 'checked' : ''} onchange="setStartSet(${originalIndex})"></td>
      <td><input type="checkbox" ${originalIndex === state.endSetIndex ? 'checked' : ''} onchange="setEndSet(${originalIndex})"></td>
      <td>${s.name}</td>
      <td>${s.bpm}</td>
      <td>${s.top}/${s.bottom}</td>
      <td>${s.measures}</td>
      <td>
        <button onclick="duplicateSet(${originalIndex})" title="Duplicate Set">📋</button>
        <button onclick="moveSetUp(${originalIndex})" title="Move Up" ${originalIndex === 0 ? 'disabled' : ''}>⬆️</button>
        <button onclick="moveSetDown(${originalIndex})" title="Move Down" ${originalIndex === state.sets.length - 1 ? 'disabled' : ''}>⬇️</button>
        <button onclick="removeSet(${originalIndex})" title="Remove Set">❌</button>
      </td>`;
    els.setTable.appendChild(row);
  });
}

// Set the start set index for playback range
function setStartSet(index) {
  state.startSetIndex = index;
  // If start is after end, move end to start
  if (state.startSetIndex > state.endSetIndex) {
    state.endSetIndex = state.startSetIndex;
  }
  renderSets();
}

// Set the end set index for playback range
function setEndSet(index) {
  state.endSetIndex = index;
  // If end is before start, move start to end
  if (state.endSetIndex < state.startSetIndex) {
    state.startSetIndex = state.endSetIndex;
  }
  renderSets();
}

// Add a new set to the list from input fields
els.addSetBtn.onclick = ()=>{
  const name = els.setName.value || `Set ${state.sets.length+1}`;
  state.sets.push({
    name: name,
    bpm: Number(els.setBpm.value),
    top: Number(els.setTop.value),
    bottom: Number(els.setBottom.value),
    measures: Number(els.setMeasures.value),
    subdivision: Number(els.subdivision.value),
    beatStates: [...state.beatStates] // Save current beat states
  });
  
  // Set default start/end if this is the first set
  if (state.sets.length === 1) {
    state.startSetIndex = 0;
    state.endSetIndex = 0;
  } else {
    // When adding any subsequent set, set end to the new set
    state.endSetIndex = state.sets.length - 1;
  }
  
  renderSets();
};

// EXPORT / IMPORT SETS
// Export sets as .openmet file (JSON with .openmet extension, group name as filename)
els.exportBtn.onclick = ()=>{
  // Save current beat states to active set before exporting
  if (state.currentSet && els.useSetsToggle.checked) {
    state.currentSet.beatStates = [...state.beatStates];
  }
  
  const data = {
    groupName: els.groupName.value || "Untitled Group",
    sets: state.sets
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  // Sanitize group name for filename
  let groupName = (els.groupName.value || "Untitled Group").replace(/[^a-z0-9_\- ]/gi, "_").replace(/\s+/g, "_");
  if (!groupName) groupName = "Untitled_Group";
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = groupName + ".openmet";
  a.click();
  URL.revokeObjectURL(url);
};

// Trigger file input for importing sets
els.importBtn.onclick = ()=> els.importFile.click();
// Import sets from a .openmet or .json file
els.importFile.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    let data = null;
    try {
      data = JSON.parse(reader.result);
    } catch (e) {
      alert("Invalid file: not valid JSON");
      return;
    }
    if (data && data.sets && Array.isArray(data.sets)) {
      state.sets = data.sets;
      els.groupName.value = data.groupName || "";
      
      // Reset set indices and load first set if available
      if (state.sets.length > 0) {
        state.startSetIndex = 0;
        state.endSetIndex = Math.min(0, state.sets.length - 1);
        state.currentSetIndex = 0;
        loadSet(0); // Load first set to display its beat states
      }
      
      renderSets();
    } else {
      alert("Invalid file: missing sets array");
    }
  };
  reader.readAsText(file);
};

// AUDIO LOGIC
// Initialize the Web Audio context for metronome sounds
function initAudio(){
  if(!state.audioCtx){
    state.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    preloadVoiceBuffers();
  }
}
// Play a metronome click sound (accented or subdivision)
function clickSound(time, accented, isSubdivision = false){
  const ctx = state.audioCtx; if(!ctx) return;
  
  // Use audio files for Click and Clinician sounds
  if (state.metronomeSound === "click" || state.metronomeSound === "clinician") {
    let audioElement;
    if (state.metronomeSound === "click") {
      // Click sound: use different files for accented vs normal
      audioElement = accented ? document.getElementById('accentClickSound') : document.getElementById('clickSound');
    } else if (state.metronomeSound === "clinician") {
      // Clinician sound: use different files for accented vs normal
      audioElement = accented ? document.getElementById('accentClinicianSound') : document.getElementById('clinicianSound');
    }
    if (audioElement) {
      // Create a new audio context source for precise timing
      const source = ctx.createBufferSource();
      const gainNode = ctx.createGain();
      
      // Set volume based on accent and subdivision
      let volume = isSubdivision ? state.subVolume : state.mainVolume;
      if (accented && !isSubdivision) volume *= 1.2; // Slightly louder for accents
      
      gainNode.gain.setValueAtTime(volume, time);
      source.connect(gainNode).connect(ctx.destination);
      
      // Load and play the audio file
      fetch(audioElement.src)
        .then(response => response.arrayBuffer())
        .then(data => ctx.decodeAudioData(data))
        .then(buffer => {
          source.buffer = buffer;
          source.start(time);
        })
        .catch(err => {
          console.warn('Failed to load metronome sound:', err);
          // Fallback to default sound
          playDefaultSound(time, accented, isSubdivision);
        });
      
      return;
    }
  }
  
  // Default sound (synthesized)
  playDefaultSound(time, accented, isSubdivision);
}

// Play the default synthesized metronome sound
function playDefaultSound(time, accented, isSubdivision) {
  const ctx = state.audioCtx;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  
  if (isSubdivision) {
    // Duller sound for subdivisions
    osc.type = "sine";
    osc.frequency.setValueAtTime(800, time);
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime(0.1 * state.subVolume, time + 0.001);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.04);
    osc.start(time); osc.stop(time + 0.06);
  } else {
    // Normal sound for main beats
    osc.type = "square";
    osc.frequency.setValueAtTime(accented ? 1800 : 1200, time);
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime((accented ? 0.3 : 0.2) * state.mainVolume, time + 0.001);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.06);
    osc.start(time); osc.stop(time + 0.08);
  }
  
  osc.connect(gain).connect(ctx.destination);
}
// Calculate interval between beats (in seconds)
function nextIntervalSeconds(){ return (60/state.bpm)*(4/state.beatUnit); }

// SETS MANAGEMENT LOGIC
// Load a set's parameters into the metronome and update UI
function loadSet(setIndex) {
  if (setIndex >= 0 && setIndex < state.sets.length) {
    const set = state.sets[setIndex];
    state.bpm = set.bpm;
    state.beatsPerBar = set.top;
    state.beatUnit = set.bottom;
    state.subdivision = set.subdivision || 1;
    state.currentSet = set;
    state.currentSetIndex = setIndex;
    state.measureIndex = 0;
    
    // Restore beat states from set data, or initialize defaults if not present
    if (set.beatStates && set.beatStates.length === set.top) {
      state.beatStates = [...set.beatStates];
    } else {
      // Initialize default beat states for new time signature
      state.beatStates = [];
      for (let i = 0; i < set.top; i++) {
        // Default: first beat accented, others normal
        state.beatStates[i] = i === 0 ? 2 : 1;
      }
    }
    
    // Update UI
    els.setBpm.value = set.bpm;
    els.setTop.value = set.top;
    els.setBottom.value = set.bottom;
    els.setMeasures.value = set.measures;
    els.subdivision.value = state.subdivision;
    
    renderBeatStrip();
  }
}

// Advance to the next set in the sequence, looping if enabled
function advanceToNextSet() {
  if (state.sets.length > 0 && els.useSetsToggle.checked) {
    const nextIndex = state.currentSetIndex + 1;
    
    // Check if we've reached the end set
    if (nextIndex > state.endSetIndex) {
      if (els.loopToggle.checked) {
        // Loop back to start set
        loadSet(state.startSetIndex);
        renderSets();
      } else {
        // Stop if loop is disabled
        stop();
      }
      return;
    }
    
    loadSet(nextIndex);
    renderSets(); // Update table highlighting
  }
}

// SCHEDULER LOGIC
// Schedule a main beat note, play sound, and handle voice/DR logic
function scheduleNote(time){
  // Check if this beat should play based on its state
  const ctx = state.audioCtx;
  const now = ctx.currentTime;
  const delay = Math.max(0, (time - now) * 1000);
  // Capture the current beat index and state for correct visual sync
  const thisBeatIndex = state.beatIndex;
  const beatState = state.beatStates[thisBeatIndex];
  if (beatState === 0) {
    setTimeout(() => {
      if (state.isRunning) flash(false, thisBeatIndex);
    }, delay);
  } else {
    const accented = beatState === 2;
    setTimeout(() => {
      if (state.isRunning) flash(accented, thisBeatIndex);
    }, delay);
    // --- Voice logic ---
    if (drMode) {
      let sfx = pickDrSfx();
      let audio = new Audio('SFX/dr/' + sfx);
      audio.play();
      const tennaVidContainer = document.getElementById('tennaVidContainer');
      const tennaVid = document.getElementById('tennaVid');
      if (tennaVidContainer && tennaVid) {
        tennaVidContainer.style.display = 'block';
        tennaVidContainer.style.opacity = '1';
        const baseBpm = 86.5;
        const speedRatio = state.bpm / baseBpm;
        tennaVid.playbackRate = speedRatio;
        if (tennaVid.paused) tennaVid.play();
      }
    } else if (
      els.voiceToggle && els.voiceToggle.checked
    ) {
      let number = thisBeatIndex + 1;
      if (number >= 1 && number <= 12) {
        let voice = null;
        if (els.voiceBrad && els.voiceBrad.checked) {
          voice = 'brad';
        } else if (els.voiceGrandpa && els.voiceGrandpa.checked) {
          voice = 'grandpa';
        } else if (els.voiceSlater && els.voiceSlater.checked) {
          voice = 'slater';
        }
        if (voice && state.voiceBuffers[voice][number]) {
          const source = state.audioCtx.createBufferSource();
          source.buffer = state.voiceBuffers[voice][number];
          source.connect(state.audioCtx.destination);
          source.start(time);
        }
      }
      clickSound(time, accented);
    } else {
      clickSound(time, accented);
    }
  }
  // Hide tenna.mp4 if not in drMode
  if (!drMode) {
    const tennaVidContainer = document.getElementById('tennaVidContainer');
    const tennaVid = document.getElementById('tennaVid');
    if (tennaVidContainer) tennaVidContainer.style.display = 'none';
    if (tennaVid && !tennaVid.paused) tennaVid.pause();
  }
  // Check if we're completing a measure
  if (state.beatIndex === state.beatsPerBar - 1) {
    state.measureIndex++;
    if (state.currentSet && els.useSetsToggle.checked && state.measureIndex >= state.currentSet.measures) {
      setTimeout(() => advanceToNextSet(), 100);
      state.measureIndex = 0;
    }
  }
  state.beatIndex = (state.beatIndex+1)%state.beatsPerBar;
  scheduleSubdivision(time);
}

// Schedule subdivision notes (between main beats)
function scheduleSubdivision(time) {
  if (state.subdivision > 1) {
    const subdivisionInterval = nextIntervalSeconds() / state.subdivision;
    for (let i = 1; i < state.subdivision; i++) {
      const subdivisionTime = time + (i * subdivisionInterval);
      // Play a duller subdivision click
      clickSound(subdivisionTime, false, true);
    }
  }
}
// Main scheduler loop: schedules notes ahead of time for smooth playback
function scheduler(){
  if(!state.isRunning) return;
  const ctx = state.audioCtx;
  while(state.nextNoteTime < ctx.currentTime+state.scheduleAheadTime){
    scheduleNote(state.nextNoteTime);
    state.nextNoteTime += nextIntervalSeconds();
  }
  state.schedulerId = setTimeout(scheduler,state.lookahead);
}

// CONTROL UPDATES
// Update state when controls change
els.setBpm.onchange = () => {
  state.bpm = Number(els.setBpm.value);
};

// Update beats per bar (top number) and re-render beat strip
els.setTop.onchange = () => {
  state.beatsPerBar = Number(els.setTop.value);
  renderBeatStrip();
};

// Update beat unit (bottom number)
els.setBottom.onchange = () => {
  state.beatUnit = Number(els.setBottom.value);
};

// Update subdivision value
els.subdivision.onchange = () => {
  state.subdivision = Number(els.subdivision.value);
};

// VOICE TOGGLE LOGIC
// Tracks timestamps for voice toggle spam detection (DR mode)
let voiceToggleSpamTimestamps = [];
// DR mode flag (special mode triggered by spamming voice toggle)
let drMode = false;
// Weighted list of DR sound effects
let drSfxList = [
  {file: 'splat.mp3', weight: 90},
  {file: 'snd.mp3', weight: 3.33},
  {file: 'explosion.mp3', weight: 3.33},
  {file: 'ominous.mp3', weight: 3.33}
];
// Array of DR quotes (loaded from textarea)
let drQuotes = null;
// Pick a DR sound effect based on weighted random selection
function pickDrSfx() {
  // Weighted random pick
  let total = drSfxList.reduce((sum, s) => sum + s.weight, 0);
  let r = Math.random() * total;
  for (let s of drSfxList) {
    if (r < s.weight) return s.file;
    r -= s.weight;
  }
  return 'splat.mp3';
}
// Display a random DR quote in the UI
function showDrQuote() {
  const el = document.getElementById('drQuote');
  if (!drQuotes) {
    // Get from textarea
    const ta = document.getElementById('drQuotesInput');
    drQuotes = ta.value.split(/\r?\n/).filter(l=>l.trim().length>0);
  }
  const line = drQuotes[Math.floor(Math.random()*drQuotes.length)];
  el.textContent = line;
  el.style.display = 'block';
}

// Make the DR quote clickable to pick a new one and play sound
document.addEventListener('DOMContentLoaded', function() {
  const drQuoteEl = document.getElementById('drQuote');
  if (drQuoteEl) {
    drQuoteEl.addEventListener('click', function(e) {
      // Only pick a new quote if visible
      if (drQuoteEl.style.display !== 'none') {
        // Pick a new quote (avoid repeating the same one if possible)
        if (!drQuotes) {
          const ta = document.getElementById('drQuotesInput');
          drQuotes = ta.value.split(/\r?\n/).filter(l=>l.trim().length>0);
        }
        let newLine;
        let tries = 0;
        do {
          newLine = drQuotes[Math.floor(Math.random()*drQuotes.length)];
          tries++;
        } while (newLine === drQuoteEl.textContent && drQuotes.length > 1 && tries < 5);
        drQuoteEl.textContent = newLine;
        // Play splat sound
        let splat = new Audio('SFX/dr/splat.mp3');
        splat.play();
      }
    });
  }
});
// Hide the DR quote display
function hideDrQuote() {
  const el = document.getElementById('drQuote');
  el.style.display = 'none';
}
// Handle voice toggle changes and DR mode activation
els.voiceToggle.onchange = () => {
  localStorage.setItem('openmet-voice-enabled', els.voiceToggle.checked ? 'true' : 'false');
  // --- DR mode spam detection ---
  const now = Date.now();
  voiceToggleSpamTimestamps.push(now);
  // Remove timestamps older than 5 seconds
  voiceToggleSpamTimestamps = voiceToggleSpamTimestamps.filter(t => now - t < 5000);
  if (!drMode && voiceToggleSpamTimestamps.length > 10) {
    drMode = true;
    // Play AUDIO_INTRONOISE.ogg
    let drIntro = new Audio('SFX/dr/AUDIO_INTRONOISE.ogg');
    drIntro.play();
    showDrQuote();
  }
};
// Restore saved voice toggle state from localStorage
const savedVoice = localStorage.getItem('openmet-voice-enabled');
if (savedVoice !== null) els.voiceToggle.checked = savedVoice === 'true';

// Voice radio button logic
// Save selected voice (Brad) to localStorage
els.voiceBrad.onchange = () => {
  if (els.voiceBrad.checked) {
    localStorage.setItem('openmet-voice-choice', 'brad');
  }
};
// Save selected voice (Grandpa) to localStorage
els.voiceGrandpa.onchange = () => {
  if (els.voiceGrandpa.checked) {
    localStorage.setItem('openmet-voice-choice', 'grandpa');
  }
};
// Save selected voice (Slater) to localStorage
els.voiceSlater.onchange = () => {
  if (els.voiceSlater.checked) {
    localStorage.setItem('openmet-voice-choice', 'slater');
  }
};
// Restore saved voice choice from localStorage
const savedVoiceChoice = localStorage.getItem('openmet-voice-choice');
if (savedVoiceChoice === 'grandpa') {
  els.voiceGrandpa.checked = true;
  els.voiceBrad.checked = false;
  els.voiceSlater.checked = false;
} else if (savedVoiceChoice === 'slater') {
  els.voiceSlater.checked = true;
  els.voiceBrad.checked = false;
  els.voiceGrandpa.checked = false;
} else {
  // Default to Brad
  els.voiceBrad.checked = true;
  els.voiceGrandpa.checked = false;
  els.voiceSlater.checked = false;
}

// SEARCH AND FILTER EVENT LISTENERS
// Add event listeners for search and filter controls
document.addEventListener('DOMContentLoaded', function() {
  const setSearch = document.getElementById('setSearch');
  const bpmFilter = document.getElementById('bpmFilter');
  const sortBy = document.getElementById('sortBy');
  const clearFilters = document.getElementById('clearFilters');
  
  if (setSearch) {
    setSearch.addEventListener('input', function() {
      state.searchTerm = this.value;
      applyFilters();
    });
  }
  
  if (bpmFilter) {
    bpmFilter.addEventListener('change', function() {
      state.bpmFilter = this.value;
      applyFilters();
    });
  }
  
  if (sortBy) {
    sortBy.addEventListener('change', function() {
      state.sortBy = this.value;
      applyFilters();
    });
  }
  
  if (clearFilters) {
    clearFilters.addEventListener('click', function() {
      state.searchTerm = "";
      state.bpmFilter = "";
      state.sortBy = "order";
      
      if (setSearch) setSearch.value = "";
      if (bpmFilter) bpmFilter.value = "";
      if (sortBy) sortBy.value = "order";
      
      applyFilters();
    });
  }
});

// METRONOME SOUND SELECTION
// Add event listeners for metronome sound selection
document.addEventListener('DOMContentLoaded', function() {
  const metronomeSounds = document.querySelectorAll('input[name="metronomeSound"]');
  
  metronomeSounds.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.checked) {
        state.metronomeSound = this.value;
        localStorage.setItem('openmet-metronome-sound', this.value);
      }
    });
  });
  
  // Restore saved metronome sound selection
  const savedMetronomeSound = localStorage.getItem('openmet-metronome-sound');
  if (savedMetronomeSound) {
    state.metronomeSound = savedMetronomeSound;
    const savedRadio = document.querySelector(`input[name="metronomeSound"][value="${savedMetronomeSound}"]`);
    if (savedRadio) {
      savedRadio.checked = true;
    }
  }
});

// Helper to get the selected voice prefix for audio element IDs
function getSelectedVoicePrefix() {
  if (els.voiceBrad && els.voiceBrad.checked) return "bradVoice";
  if (els.voiceGrandpa && els.voiceGrandpa.checked) return "grandpaVoice";
  if (els.voiceSlater && els.voiceSlater.checked) return "slaterVoice";
  return "bradVoice"; // fallback
}

// Helper for voice playback: use voicePrefix + number for audio element ID
let voicePrefix = getSelectedVoicePrefix();

// START/STOP LOGIC
// Start the metronome
function start(){
  startUsageTimer();
  initAudio();
  actuallyStartMet();
}


// Actually start the metronome and initialize set
function actuallyStartMet() {
  state.isRunning = true;
  state.measureIndex = 0;
  state.beatIndex = 0; // Reset to first beat

  // Initialize first set if using sets
  if (els.useSetsToggle.checked && state.sets.length > 0) {
    loadSet(state.startSetIndex);
    renderSets(); // Update table highlighting
  }

  // Start metronome immediately
  state.nextNoteTime = state.audioCtx.currentTime + 0.05;
  scheduler();

  // Update start/stop button appearance
  els.toggleBtn.textContent = "⏹";
  els.toggleBtn.className = "btn danger";
}
// Stop the metronome and update UI
function stop(){
  stopUsageTimer();
  updateUsageStatsUI();
  state.isRunning=false;
  clearTimeout(state.schedulerId); state.schedulerId=null;
  
  // Update start/stop button appearance
  els.toggleBtn.textContent = "▶";
  els.toggleBtn.className = "btn primary";
  
  // Remove set highlighting when stopped
  if (els.useSetsToggle.checked) {
    renderSets();
  }
}

// Toggle function for start/stop button
function toggleMetronome() {
  if (state.isRunning) {
    stop();
  } else {
    start();
  }
}

els.toggleBtn.onclick = toggleMetronome;

// --- VISUALS ---
// Flash the LED for each beat
function flash(accented){
  // Theme-aware LED blink logic
  // Accepts optional beatIndex for correct highlighting
  let beatIndex = arguments.length > 1 ? arguments[1] : state.beatIndex;
  const theme = document.body.className;
  let defaultColor, flashColor;
  switch (theme) {
    case "light-mode":
      defaultColor = "#e2e8f0";
      flashColor = accented ? "#3b82f6" : "#34d399";
      break;
    case "high-contrast":
      defaultColor = "#fff";
      flashColor = accented ? "#fff" : "#ff0";
      break;
    case "solarized-dark":
      defaultColor = "#b58900";
      flashColor = accented ? "#268bd2" : "#2aa198";
      break;
    case "solarized-light":
      defaultColor = "#b58900";
      flashColor = accented ? "#657b83" : "#93a1a1";
      break;
    case "monochrome":
      defaultColor = "#eee";
      flashColor = accented ? "#888" : "#222";
      break;
    case "pastel":
      defaultColor = "#c8b6ff";
      flashColor = accented ? "#6c5b7b" : "#f7f3fa";
      break;
    case "retro":
      defaultColor = "#f2e9e4";
      flashColor = accented ? "#9a8c98" : "#22223b";
      break;
    case "ocean":
      defaultColor = "#3bb3c3";
      flashColor = accented ? "#176582" : "#a7e9e6";
      break;
    default:
      defaultColor = "#1b2347";
      flashColor = accented ? "#7c9cff" : "#34d399";
  }
  els.led.style.setProperty('background', flashColor, 'important');
  setTimeout(()=>els.led.style.setProperty('background', defaultColor, 'important'),80);
  highlightBeat(beatIndex);
}
// Render the beat strip
function renderBeatStrip(){
  els.beatStrip.innerHTML="";
  
  // Initialize beat states if needed
  if (state.beatStates.length !== state.beatsPerBar) {
    state.beatStates = [];
    for (let i = 0; i < state.beatsPerBar; i++) {
      // Default: first beat accented, others normal
      state.beatStates[i] = i === 0 ? 2 : 1;
    }
  }
  
  const theme = document.body.className;
  for(let i=0;i<state.beatsPerBar;i++){
    const div=document.createElement("div");
    div.style.flex="1"; 
    div.style.height="16px"; 
    div.style.borderRadius="6px";
    div.style.cursor="pointer";
    div.style.transition="background-color 0.2s";
    // Set background based on beat state and theme
    switch(theme) {
      case "high-contrast":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#222"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#fff200"; div.style.opacity="1"; break;
          case 2: div.style.background="#fff"; div.style.opacity="1"; break;
        } break;
      case "solarized-dark":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#073642"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#586e75"; div.style.opacity="1"; break;
          case 2: div.style.background="#b58900"; div.style.opacity="1"; break;
        } break;
      case "solarized-light":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#eee8d5"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#93a1a1"; div.style.opacity="1"; break;
          case 2: div.style.background="#b58900"; div.style.opacity="1"; break;
        } break;
      case "monochrome":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#333"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#888"; div.style.opacity="1"; break;
          case 2: div.style.background="#eee"; div.style.opacity="1"; break;
        } break;
      case "pastel":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#fceff9"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#c8b6ff"; div.style.opacity="1"; break;
          case 2: div.style.background="#6c5b7b"; div.style.opacity="1"; break;
        } break;
      case "retro":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#4a4e69"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#9a8c98"; div.style.opacity="1"; break;
          case 2: div.style.background="#f2e9e4"; div.style.opacity="1"; break;
        } break;
      case "ocean":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#176582"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#3bb3c3"; div.style.opacity="1"; break;
          case 2: div.style.background="#a7e9e6"; div.style.opacity="1"; break;
        } break;
      case "light-mode":
        switch(state.beatStates[i]) {
          case 0: div.style.background="#e2e8f0"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#e2e8f0"; div.style.opacity="1"; break;
          case 2: div.style.background="#3b82f6"; div.style.opacity="1"; break;
        } break;
      default:
        switch(state.beatStates[i]) {
          case 0: div.style.background="#1a2145"; div.style.opacity="0.3"; break;
          case 1: div.style.background="#1a2145"; div.style.opacity="1"; break;
          case 2: div.style.background="#3b82f6"; div.style.opacity="1"; break;
        } break;
    }
    // Add click handler to cycle beat state
    div.onclick = () => cycleBeatState(i);
    els.beatStrip.appendChild(div);
  }
}

// Initialize visuals on page load
renderBeatStrip();

// --- RESET FORM INPUTS TO DEFAULTS ON PAGE LOAD ---
function resetToDefaults() {
  els.setBpm.value = "120";
  els.setTop.value = "4";
  els.setBottom.value = "4";
  els.setMeasures.value = "4";
  els.subdivision.value = "1";
  els.setName.value = "";
  els.groupName.value = "";
  els.useSetsToggle.checked = false;
  els.loopToggle.checked = false;
  
  // Load saved light mode preference
  const savedLightMode = localStorage.getItem('openmet-light-mode');
  if (savedLightMode === 'true') {
    els.lightModeToggle.checked = true;
    document.body.classList.add("light-mode");
  } else {
    els.lightModeToggle.checked = false;
    document.body.classList.remove("light-mode");
  }
  
  // Load saved volume preferences
  const savedMainVolume = localStorage.getItem('openmet-main-volume');
  const savedSubVolume = localStorage.getItem('openmet-sub-volume');
  
  if (savedMainVolume !== null) {
    els.mainVolume.value = savedMainVolume;
    els.mainVolumeValue.textContent = savedMainVolume + "%";
    state.mainVolume = savedMainVolume / 100;
  } else {
    els.mainVolume.value = "80";
    els.mainVolumeValue.textContent = "80%";
    state.mainVolume = 0.8;
  }
  
  if (savedSubVolume !== null) {
    els.subVolume.value = savedSubVolume;
    els.subVolumeValue.textContent = savedSubVolume + "%";
    state.subVolume = savedSubVolume / 100;
  } else {
    els.subVolume.value = "60";
    els.subVolumeValue.textContent = "60%";
    state.subVolume = 0.6;
  }
  
  // Reset state to match defaults
  state.bpm = 120;
  state.beatsPerBar = 4;
  state.beatUnit = 4;
  state.subdivision = 1;
  // Volume state is now set above based on localStorage or defaults
  state.sets = [];
  state.currentSetIndex = 0;
  state.beatIndex = 0;
  state.measureIndex = 0;
  state.currentSet = null;
  state.beatStates = [];
  state.startSetIndex = 0;
  state.endSetIndex = 0;
  
  // Re-render to show default beat states
  renderBeatStrip();
}

// Call reset on page load
resetToDefaults();

// --- BEAT STRIP INTERACTION ---
// Cycle a beat's state (off -> normal -> accented -> off)
function cycleBeatState(beatIndex) {
  state.beatStates[beatIndex] = (state.beatStates[beatIndex] + 1) % 3;
  
  // Save beat states to current set if using sets
  if (state.currentSet && els.useSetsToggle.checked) {
    state.currentSet.beatStates = [...state.beatStates];
  }
  
  // Update the visual
  const beatElement = els.beatStrip.children[beatIndex];
  if (beatElement) {
    const theme = document.body.className;
    switch(theme) {
      case "high-contrast":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#222"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#fff200"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#fff"; beatElement.style.opacity="1"; break;
        } break;
      case "solarized-dark":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#073642"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#586e75"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#b58900"; beatElement.style.opacity="1"; break;
        } break;
      case "solarized-light":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#eee8d5"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#93a1a1"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#b58900"; beatElement.style.opacity="1"; break;
        } break;
      case "monochrome":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#333"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#888"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#eee"; beatElement.style.opacity="1"; break;
        } break;
      case "pastel":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#fceff9"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#c8b6ff"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#6c5b7b"; beatElement.style.opacity="1"; break;
        } break;
      case "retro":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#4a4e69"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#9a8c98"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#f2e9e4"; beatElement.style.opacity="1"; break;
        } break;
      case "ocean":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#176582"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#3bb3c3"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#a7e9e6"; beatElement.style.opacity="1"; break;
        } break;
      case "light-mode":
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#e2e8f0"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#e2e8f0"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#3b82f6"; beatElement.style.opacity="1"; break;
        } break;
      default:
        switch(state.beatStates[beatIndex]) {
          case 0: beatElement.style.background="#1a2145"; beatElement.style.opacity="0.3"; break;
          case 1: beatElement.style.background="#1a2145"; beatElement.style.opacity="1"; break;
          case 2: beatElement.style.background="#3b82f6"; beatElement.style.opacity="1"; break;
        } break;
    }
  }
}

// Highlight the current beat in the beat strip
function highlightBeat(i){
  [...els.beatStrip.children].forEach((el,idx)=>{
    el.style.outline= idx===i? "2px solid #7c9cff":"none";
  });
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenMet</title>
<style>
/* --- GENERAL STYLES --- */
body{margin:0;font-family:sans-serif;background:#0f1220;color:#e8ebff;display:grid;place-items:center;min-height:100vh}
.card{width:min(1000px,100%);background:#161a2b;border-radius:20px;padding:20px;position:relative}
h1{margin:0 0 10px;display:flex;justify-content:space-between;align-items:center}
.panel{background:#0f1530;border:1px solid #212848;border-radius:16px;padding:16px;margin-top:12px}
input,select,button{padding:6px 10px;border-radius:8px;border:1px solid #2a3358;background:#0e1433;color:#fff}
button{cursor:pointer}
button[title] {
  font-size: 16px;
  min-width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Remove number input spinners */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -webkit-appearance: textfield;
  -moz-appearance: textfield;
  appearance: textfield;
}
.btn.primary{background:#7c9cff;border:none;color:#ffffff}
.btn.success{background:#34d399;border:none}
.btn.danger{background:#f87171;border:none;color:#ffffff}
.btn.ghost{background:#0e1433;border:1px solid #2a3358}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px 8px;text-align:center;border-bottom:1px solid #2a3358}
tr.active-set{background:#1b2347}
.info-icon{cursor:pointer;font-size:20px}
#infoPanel{position:absolute;top:20px;right:20px;width:300px;background:#0f1530;border:1px solid #212848;border-radius:12px;padding:16px;display:none;z-index:10}
#infoPanel h2{margin:0 0 6px;font-size:18px}
#infoPanel p{margin:0;font-size:14px;line-height:1.4}
#closeInfo{cursor:pointer;color:#f87171;float:right;font-weight:bold}

/* Settings icon styling */
.settings-icon {
  cursor: pointer;
  font-size: 20px;
  padding: 4px;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.settings-icon:hover {
  background-color: rgba(124, 156, 255, 0.2);
}

/* Settings panel styles */
#settingsPanel{position:absolute;top:20px;right:20px;width:300px;background:#0f1530;border:1px solid #212848;border-radius:12px;padding:16px;display:none;z-index:10}
#settingsPanel h2{margin:0 0 12px;font-size:18px}
#settingsPanel h3{margin:12px 0 8px;font-size:14px;color:#8b9bb4}
.setting-group{margin-bottom:16px}
#closeSettings{cursor:pointer;color:#f87171;float:right;font-weight:bold}

/* Settings tabs */
.settings-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.settings-tab {
  padding: 6px 16px;
  border-radius: 8px 8px 0 0;
  background: #161a2b;
  color: #7c9cff;
  cursor: pointer;
  border: none;
  outline: none;
  font-weight: bold;
  transition: background 0.2s;
}
.settings-tab.active {
  background: #0f1530;
  color: #fff;
  border-bottom: 2px solid #7c9cff;
}
body.light-mode .settings-tab {
  background: #f1f5f9;
  color: #3b82f6;
}
body.light-mode .settings-tab.active {
  background: #fff;
  color: #1e293b;
  border-bottom: 2px solid #3b82f6;
}

/* Light mode styles */
body.light-mode{background:#f8fafc;color:#1e293b}
body.light-mode .card{background:#ffffff;border:1px solid #e2e8f0}
body.light-mode .panel{background:#f1f5f9;border:1px solid #cbd5e1}
body.light-mode input,body.light-mode select{border:1px solid #cbd5e1;background:#ffffff;color:#1e293b}
body.light-mode th,body.light-mode td{border-bottom:1px solid #cbd5e1}
body.light-mode tr.active-set{background:#e2e8f0}
body.light-mode #infoPanel,body.light-mode #settingsPanel{background:#ffffff;border:1px solid #cbd5e1}
body.light-mode #led{background:#e2e8f0}
body.light-mode .btn.ghost{background:#ffffff;border:1px solid #cbd5e1;color:#1e293b}
body.light-mode button{background:#ffffff;border:1px solid #cbd5e1;color:#1e293b}

/* Light mode LED and beat indicators */
body.light-mode #led{background:#e2e8f0}
body.light-mode .beat-indicator{background:#e2e8f0;border:1px solid #cbd5e1}

/* Light mode toggle switches */
body.light-mode .slider{background-color:#cbd5e1}
body.light-mode .slider:before{background-color:#64748b}
body.light-mode input:checked + .slider{background-color:#3b82f6}
body.light-mode input:checked + .slider:before{background-color:#ffffff}

/* Toggle switch styles */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #2a3358;
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: #8b9bb4;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #7c9cff;
}

input:checked + .slider:before {
  transform: translateX(26px);
  background-color: #fff;
}

/* --- MOBILE FRIENDLY STYLES --- */
@media (max-width: 700px) {
  .card {
    width: 98vw;
    padding: 8px;
    border-radius: 0;
    min-width: unset;
  }
  h1 {
    flex-direction: column;
    gap: 8px;
    font-size: 1.3em;
  }
  .panel {
    padding: 8px;
    margin-top: 8px;
    border-radius: 10px;
  }
  .row {
    flex-direction: row !important;
    gap: 6px;
    margin-top: 4px;
    flex-wrap: wrap;
    width: 100%;
  }
  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }
  thead {
    display: none;
  }
  tr {
    margin-bottom: 10px;
    border-bottom: 1px solid #2a3358;
    background: none !important;
    border-radius: 8px;
  }
  td {
    text-align: left;
    padding: 6px 4px;
    border: none;
    font-size: 1em;
  }
  .settings-tabs {
    flex-direction: column;
    gap: 2px;
  }
  .settings-tab {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 2px;
    font-size: 1em;
    padding: 8px 0;
  }
  #settingsPanel, #infoPanel {
    width: 98vw !important;
    left: 1vw !important;
    right: unset !important;
    top: 10px !important;
    min-width: unset;
    max-width: 98vw;
    border-radius: 10px;
    padding: 10px;
  }
  input, select, button {
    font-size: 1em;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
  }
  label {
    width: 100%;
  }
  .toggle-switch {
    width: 40px;
    min-width: 40px;
    height: 22px;
  }
  .slider {
    min-width: 40px;
  }
  .slider:before {
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 3px;
  }
  .panel > div, .panel > label {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 8px !important;
  }
    /* Stack Sounds tab settings vertically on mobile */
    #soundsTab .setting-group {
      display: flex !important;
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 8px !important;
      width: auto !important;
    }
    #soundsTab label {
      display: flex !important;
      flex-direction: row !important;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      width: auto !important;
      margin-bottom: 0 !important;
      gap: 0 !important;
      text-align: left !important;
    }
    #soundsTab input[type="radio"],
    #soundsTab input[type="checkbox"] {
      align-self: center !important;
      margin-right: 0.1em !important;
      position: static;
      left: auto;
    }
    #soundsTab span {
      text-align: left !important;
      flex: none;
      margin: 0 !important;
    }
    #soundsTab .toggle-switch {
      margin-left: 0 !important;
    }
  #led {
    width: 40px !important;
    height: 40px !important;
  }
  #beatStrip {
    gap: 3px !important;
  }

  /* Center the tempo, subdivision, and time signature controls */
    .panel > .row[style*="margin-left:auto"],
    .panel > div > .row[style*="margin-left:auto"] {
      margin-left: 0 !important;
      justify-content: center !important;
      align-items: center !important;
      text-align: center;
      width: 100%;
      flex-direction: row !important;
      flex-wrap: wrap;
      gap: 6px;
    }
    .panel > .row[style*="margin-left:auto"] label,
    .panel > div > .row[style*="margin-left:auto"] label {
      align-items: center !important;
      width: auto;
      justify-content: center !important;
      text-align: center;
      margin-bottom: 0;
      flex: 1 1 0;
      min-width: 0;
    }
    .panel > .row[style*="margin-left:auto"] input,
    .panel > .row[style*="margin-left:auto"] select,
    .panel > div > .row[style*="margin-left:auto"] input,
    .panel > div > .row[style*="margin-left:auto"] select {
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      display: block;
      width: 70px;
      min-width: 0;
    }
}

/* Make buttons and inputs easier to tap */
button, input, select {
  touch-action: manipulation;
}

/* Prevent horizontal scroll */
html, body {
  max-width: 100vw;
  overflow-x: hidden;
}
</style>
</head>
<body>
  <!-- Countoff overlay -->
  <div id="countoffOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:200;pointer-events:none;display:flex;align-items:center;justify-content:center;">
    <div style="background:rgba(22,26,43,0.95);color:#fff;padding:40px 60px;border-radius:24px;font-size:5em;font-weight:bold;box-shadow:0 4px 32px #000a;min-width:180px;text-align:center;user-select:none;">
      <span id="countoffNumber">1</span>
    </div>
  </div>
  <div class="card">
    <h1>
      OpenMet
      <div style="display:flex;gap:8px;align-items:center">
        <span class="settings-icon" id="settingsIcon">⚙️</span>
      </div>
    </h1>

  <!-- Copyright and GitHub link bottom left -->
  <div style="position:fixed;bottom:10px;left:10px;z-index:100;font-size:13px;color:#8b9bb4;display:flex;align-items:center;gap:10px;">
    <span>OpenMet © 2025 by Slater Feistner</span>
    <a href="https://github.com/PossiblySlater/OpenMet" target="_blank" style="color:#7c9cff;text-decoration:none;display:flex;align-items:center;gap:4px;">
      <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
      <span>GitHub</span>
    </a>
  </div>

  <!-- Settings panel (Appearance, Audio, Sounds) -->
  <div id="settingsPanel">
    <span id="closeSettings">✖</span>
    <h2>Settings</h2>
    
    <!-- Settings Tabs -->
    <div class="settings-tabs">
      <button class="settings-tab active" id="appearanceTabBtn">Appearance</button>
      <button class="settings-tab" id="audioTabBtn">Audio</button>
      <button class="settings-tab" id="soundsTabBtn">Sounds</button>
    </div>
    
    <!-- Appearance Tab -->
    <div class="setting-group settings-tab-content" id="appearanceTab" style="display:block">
      <h3>Appearance</h3>
      <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
        <span>Light Mode</span>
        <label class="toggle-switch">
          <input type="checkbox" id="lightModeToggle">
          <span class="slider"></span>
        </label>
      </label>
    </div>
    
    <!-- Audio Tab -->
    <div class="settings-tab-content" id="audioTab" style="display:none">
      <div class="setting-group">
        <h3>Audio</h3>
        <label style="display:flex;flex-direction:column;gap:4px;margin:8px 0">
          <span>Main Beat Volume</span>
          <input type="range" id="mainVolume" min="0" max="100" value="80" style="width:200px">
          <span id="mainVolumeValue">80%</span>
        </label>
        <label style="display:flex;flex-direction:column;gap:4px;margin:8px 0">
          <span>Subdivision Volume</span>
          <input type="range" id="subVolume" min="0" max="100" value="60" style="width:200px">
          <span id="subVolumeValue">60%</span>
        </label>
      </div>
    </div>
    
    <!-- Sounds Tab -->
    <div class="settings-tab-content" id="soundsTab" style="display:none">
      <div class="setting-group">
        <h3>Metronome</h3>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
          <input type="radio" name="metronomeSound" id="metronomeDefault" value="default" checked>
          <span style="text-align:left">Default</span>
        </label>
        <!-- Add more metronome sounds here in the future -->
      </div>
      <div class="setting-group">
        <h3>Voice</h3>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <span style="text-align:left">Voice</span>
            <label class="toggle-switch">
              <input type="checkbox" id="voiceToggle">
              <span class="slider"></span>
            </label>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <input type="radio" name="voiceSound" id="voiceBrad" value="brad" checked>
            <span style="text-align:left">Brad</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <input type="radio" name="voiceSound" id="voiceGrandpa" value="grandpa">
            <span style="text-align:left">Grandpa</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
            <input type="radio" name="voiceSound" id="voiceSlater" value="slater">
            <span style="text-align:left">Slater</span>
          </label>
        </div>
      <div class="setting-group">
        <h3>Countoff</h3>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0">
          <span style="text-align:left">Countoff</span>
          <label class="toggle-switch">
            <input type="checkbox" id="countoffToggle">
            <span class="slider"></span>
          </label>
        </label>
      </div>
    </div>
  </div>

  <!-- Metronome visuals: LED and beat strip -->
  <div class="panel">
    <div style="display:flex;gap:20px;align-items:center">
      <div id="led" style="width:60px;height:60px;border-radius:50%;background:#1b2347"></div>
      <div id="beatStrip" style="display:flex;gap:6px;flex:1"></div>
    </div>
  </div>

  <!-- Controls: Start/Stop, Export/Import, Tempo, Subdivision, Time Signature -->
  <div class="panel">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <!-- Left: Start/Stop/Export/Import -->
      <div class="row">
        <button id="toggleBtn" class="btn primary" title="Start/Stop">▶</button>
        <button id="exportBtn" class="btn success" title="Export Sets">📤</button>
        <input type="file" id="importFile" style="display:none">
        <button id="importBtn" class="btn ghost" title="Import Sets">📥</button>
      </div>

      <!-- Right: Tempo / TS -->
      <div class="row" style="margin-left:auto;gap:6px;align-items:center">
        <label style="margin:0;display:flex;flex-direction:column;align-items:flex-start">
          BPM
          <input id="setBpm" type="number" min="20" max="300" value="120" style="width:70px">
        </label>

        <label style="margin:0;display:flex;flex-direction:column;align-items:flex-start">
          Subdivision
          <select id="subdivision" style="width:70px">
            <option value="1">None</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
          </select>
        </label>

        <label style="margin:0;display:flex;flex-direction:column;align-items:flex-start">
          <input id="setTop" type="number" min="1" max="12" value="4" style="width:50px;text-align:center">
          <div style="width:25px;height:1px;background:#e8ebff;margin:2px auto"></div>
          <select id="setBottom" style="width:70px;text-align:center">
            <option value="1">1</option><option value="2">2</option>
            <option value="4" selected>4</option><option value="8">8</option><option value="16">16</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <!-- Sets programming: Group name, sets table, add set, toggles -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
      <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
        Group Name
        <input id="groupName" type="text" placeholder="Enter group name" style="width:200px">
      </label>
      
      <div style="display:flex;gap:8px;align-items:flex-end">
        <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
          Set Name
          <input id="setName" type="text" placeholder="Enter set name" style="width:120px">
        </label>
        <label style="display:flex;flex-direction:column;align-items:flex-start;margin:0">
          Measures
          <input id="setMeasures" type="number" min="1" value="4" style="width:60px">
        </label>
        <button id="addSetBtn" class="btn success" title="Add Set">➕</button>
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <span style="font-size:14px">Use Sets</span>
          <label class="toggle-switch">
            <input type="checkbox" id="useSetsToggle">
            <span class="slider"></span>
          </label>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <span style="font-size:14px">Loop</span>
          <label class="toggle-switch">
            <input type="checkbox" id="loopToggle">
            <span class="slider"></span>
          </label>
        </label>
      </div>
    </div>
    <h3>Program Sets</h3>
    <table>
      <thead><tr><th>#</th><th>Start</th><th>End</th><th>Set Name</th><th>BPM</th><th>TS</th><th>Measures</th><th>Actions</th></tr></thead>
      <tbody id="setTable"></tbody>
    </table>
  </div>
</div>

<!-- Hidden audio elements for voice counting -->
<div id="voice-audio" style="display:none">
  <!-- Grandpa -->
  <audio id="grandpaVoice1" src="Voices/Grandpa/1.mp3"></audio>
  <audio id="grandpaVoice2" src="Voices/Grandpa/2.mp3"></audio>
  <audio id="grandpaVoice3" src="Voices/Grandpa/3.mp3"></audio>
  <audio id="grandpaVoice4" src="Voices/Grandpa/4.mp3"></audio>
  <audio id="grandpaVoice5" src="Voices/Grandpa/5.mp3"></audio>
  <audio id="grandpaVoice6" src="Voices/Grandpa/6.mp3"></audio>
  <audio id="grandpaVoice7" src="Voices/Grandpa/7.mp3"></audio>
  <audio id="grandpaVoice8" src="Voices/Grandpa/8.mp3"></audio>
  <audio id="grandpaVoice9" src="Voices/Grandpa/9.mp3"></audio>
  <audio id="grandpaVoice10" src="Voices/Grandpa/10.mp3"></audio>
  <audio id="grandpaVoice11" src="Voices/Grandpa/11.mp3"></audio>
  <audio id="grandpaVoice12" src="Voices/Grandpa/12.mp3"></audio>
  <!-- Slater -->
  <audio id="slaterVoice1" src="Voices/Slater/1.mp3"></audio>
  <audio id="slaterVoice2" src="Voices/Slater/2.mp3"></audio>
  <audio id="slaterVoice3" src="Voices/Slater/3.mp3"></audio>
  <audio id="slaterVoice4" src="Voices/Slater/4.mp3"></audio>
  <audio id="slaterVoice5" src="Voices/Slater/5.mp3"></audio>
  <audio id="slaterVoice6" src="Voices/Slater/6.mp3"></audio>
  <audio id="slaterVoice7" src="Voices/Slater/7.mp3"></audio>
  <audio id="slaterVoice8" src="Voices/Slater/8.mp3"></audio>
  <audio id="slaterVoice9" src="Voices/Slater/9.mp3"></audio>
  <audio id="slaterVoice10" src="Voices/Slater/10.mp3"></audio>
  <audio id="slaterVoice11" src="Voices/Slater/11.mp3"></audio>
  <audio id="slaterVoice12" src="Voices/Slater/12.mp3"></audio>
  <!-- Brad -->
  <audio id="bradVoice1" src="Voices/Brad/1.mp3"></audio>
  <audio id="bradVoice2" src="Voices/Brad/2.mp3"></audio>
  <audio id="bradVoice3" src="Voices/Brad/3.mp3"></audio>
  <audio id="bradVoice4" src="Voices/Brad/4.mp3"></audio>
  <audio id="bradVoice5" src="Voices/Brad/5.mp3"></audio>
  <audio id="bradVoice6" src="Voices/Brad/6.mp3"></audio>
  <audio id="bradVoice7" src="Voices/Brad/7.mp3"></audio>
  <audio id="bradVoice8" src="Voices/Brad/8.mp3"></audio>
  <audio id="bradVoice9" src="Voices/Brad/9.mp3"></audio>
  <audio id="bradVoice10" src="Voices/Brad/10.mp3"></audio>
  <audio id="bradVoice11" src="Voices/Brad/11.mp3"></audio>
  <audio id="bradVoice12" src="Voices/Brad/12.mp3"></audio>
</div>

<script>
// --- ELEMENT REFERENCES ---
// All main UI elements are collected here for easy access
document.addEventListener('DOMContentLoaded', () => {
  hideCountoffNumber();
});
const els = {
  led: document.getElementById("led"),
  beatStrip: document.getElementById("beatStrip"),
  toggleBtn: document.getElementById("toggleBtn"),
  setBpm: document.getElementById("setBpm"),
  setTop: document.getElementById("setTop"),
  setBottom: document.getElementById("setBottom"),
  setMeasures: document.getElementById("setMeasures"),
  subdivision: document.getElementById("subdivision"),
  setName: document.getElementById("setName"),
  addSetBtn: document.getElementById("addSetBtn"),
  setTable: document.getElementById("setTable"),
  exportBtn: document.getElementById("exportBtn"),
  importBtn: document.getElementById("importBtn"),
  importFile: document.getElementById("importFile"),
  useSetsToggle: document.getElementById("useSetsToggle"),
  loopToggle: document.getElementById("loopToggle"),
  groupName: document.getElementById("groupName"),
  infoIcon: document.getElementById("infoIcon"),
  infoPanel: document.getElementById("infoPanel"),
  closeInfo: document.getElementById("closeInfo"),
  settingsIcon: document.getElementById("settingsIcon"),
  settingsPanel: document.getElementById("settingsPanel"),
  closeSettings: document.getElementById("closeSettings"),
  lightModeToggle: document.getElementById("lightModeToggle"),
  mainVolume: document.getElementById("mainVolume"),
  subVolume: document.getElementById("subVolume"),
  mainVolumeValue: document.getElementById("mainVolumeValue"),
  subVolumeValue: document.getElementById("subVolumeValue"),
  voiceToggle: document.getElementById("voiceToggle"),
  voiceBrad: document.getElementById("voiceBrad"),
  voiceGrandpa: document.getElementById("voiceGrandpa"),
  voiceSlater: document.getElementById("voiceSlater"),
  countoffToggle: document.getElementById("countoffToggle"),
};

// --- APPLICATION STATE ---

// --- COUNT-OFF OVERLAY LOGIC ---
function showCountoffNumber(num) {
  const overlay = document.getElementById('countoffOverlay');
  const numberSpan = document.getElementById('countoffNumber');
  if (overlay && numberSpan) {
    numberSpan.textContent = num;
    overlay.style.display = 'flex';
  }
}

function hideCountoffNumber() {
  const overlay = document.getElementById('countoffOverlay');
  if (overlay) overlay.style.display = 'none';
}
// All runtime state is stored here
let state = {
  sets: [],
  currentSetIndex: 0,
  beatIndex: 0,
  measureIndex: 0,
  isRunning: false,
  bpm: 120,
  beatsPerBar: 4,
  beatUnit: 4,
  subdivision: 1,
  mainVolume: 0.8,
  subVolume: 0.6,
  audioCtx: null,
  nextNoteTime: 0,
  lookahead: 25,
  scheduleAheadTime: 0.1,
  schedulerId: null,
  currentSet: null,
  beatStates: [], // 0 = off, 1 = normal, 2 = accented
  startSetIndex: 0,
  endSetIndex: 0
};



// --- SETTINGS PANEL LOGIC ---
els.settingsIcon.onclick = ()=> els.settingsPanel.style.display="block";
els.closeSettings.onclick = ()=> els.settingsPanel.style.display="none";

// --- SETTINGS FUNCTIONALITY ---
// Light mode toggle
els.lightModeToggle.onchange = () => {
  if (els.lightModeToggle.checked) {
    document.body.classList.add("light-mode");
    localStorage.setItem('openmet-light-mode', 'true');
  } else {
    document.body.classList.remove("light-mode");
    localStorage.setItem('openmet-light-mode', 'false');
  }
  // Re-render beat strip to update colors
  renderBeatStrip();
};

// Volume sliders
els.mainVolume.oninput = () => {
  const value = els.mainVolume.value;
  els.mainVolumeValue.textContent = value + "%";
  state.mainVolume = value / 100;
  localStorage.setItem('openmet-main-volume', value);
};

els.subVolume.oninput = () => {
  const value = els.subVolume.value;
  els.subVolumeValue.textContent = value + "%";
  state.subVolume = value / 100;
  localStorage.setItem('openmet-sub-volume', value);
};

// --- SETTINGS TABS LOGIC ---
const tabBtns = {
  appearance: document.getElementById("appearanceTabBtn"),
  audio: document.getElementById("audioTabBtn"),
  sounds: document.getElementById("soundsTabBtn")
};
const tabContents = {
  appearance: document.getElementById("appearanceTab"),
  audio: document.getElementById("audioTab"),
  sounds: document.getElementById("soundsTab")
};
// Show the selected tab and hide others
function showTab(tab) {
  for (const key in tabBtns) {
    tabBtns[key].classList.toggle("active", key === tab);
    tabContents[key].style.display = key === tab ? "block" : "none";
  }
}
tabBtns.appearance.onclick = () => showTab("appearance");
tabBtns.audio.onclick = () => showTab("audio");
tabBtns.sounds.onclick = () => showTab("sounds");

// --- SETS MANAGEMENT ---
// Render the sets table
function renderSets(){
  els.setTable.innerHTML = "";
  state.sets.forEach((s,i)=>{
    const row = document.createElement("tr");
    // Only highlight if metronome is running, using sets, and this is the current set
    if(state.currentSetIndex === i && state.isRunning && els.useSetsToggle.checked){
      row.classList.add("active-set");
      row.style.background = "#1b2347";
      row.style.border = "2px solid #7c9cff";
    } else {
      // Reset to default styling when not highlighted
      row.style.background = "";
      row.style.border = "";
    }
    row.innerHTML = `<td>${i+1}</td>
      <td><input type="checkbox" ${i === state.startSetIndex ? 'checked' : ''} onchange="setStartSet(${i})"></td>
      <td><input type="checkbox" ${i === state.endSetIndex ? 'checked' : ''} onchange="setEndSet(${i})"></td>
      <td>${s.name}</td>
      <td>${s.bpm}</td>
      <td>${s.top}/${s.bottom}</td>
      <td>${s.measures}</td>
      <td><button onclick="removeSet(${i})" title="Remove Set">❌</button></td>`;
    els.setTable.appendChild(row);
  });
}
// Remove a set from the list
function removeSet(i){ 
  state.sets.splice(i,1); 
  
  // Adjust start/end indices if needed
  if (state.startSetIndex >= state.sets.length) {
    state.startSetIndex = Math.max(0, state.sets.length - 1);
  }
  if (state.endSetIndex >= state.sets.length) {
    state.endSetIndex = Math.max(0, state.sets.length - 1);
  }
  
  renderSets(); 
}

// Set the start set index
function setStartSet(index) {
  state.startSetIndex = index;
  // If start is after end, move end to start
  if (state.startSetIndex > state.endSetIndex) {
    state.endSetIndex = state.startSetIndex;
  }
  renderSets();
}

// Set the end set index
function setEndSet(index) {
  state.endSetIndex = index;
  // If end is before start, move start to end
  if (state.endSetIndex < state.startSetIndex) {
    state.startSetIndex = state.endSetIndex;
  }
  renderSets();
}

// Add a new set to the list
els.addSetBtn.onclick = ()=>{
  const name = els.setName.value || `Set ${state.sets.length+1}`;
  state.sets.push({
    name: name,
    bpm: Number(els.setBpm.value),
    top: Number(els.setTop.value),
    bottom: Number(els.setBottom.value),
    measures: Number(els.setMeasures.value),
    subdivision: Number(els.subdivision.value)
  });
  
  // Set default start/end if this is the first set
  if (state.sets.length === 1) {
    state.startSetIndex = 0;
    state.endSetIndex = 0;
  } else {
    // When adding any subsequent set, set end to the new set
    state.endSetIndex = state.sets.length - 1;
  }
  
  renderSets();
};

// --- EXPORT / IMPORT SETS ---
// Export sets as JSON file
els.exportBtn.onclick = ()=>{
  const data = {
    groupName: els.groupName.value || "Untitled Group",
    sets: state.sets
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="openmet_sets.json"; a.click();
  URL.revokeObjectURL(url);
};
// Import sets from JSON file
els.importBtn.onclick = ()=> els.importFile.click();
els.importFile.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      state.sets = data.sets || [];
      els.groupName.value = data.groupName || "";
      renderSets();
    }catch(e){ alert("Invalid JSON"); }
  };
  reader.readAsText(file);
};

// --- AUDIO LOGIC ---
// Initialize audio context
function initAudio(){
  if(!state.audioCtx){ state.audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
}
// Play a metronome click sound
function clickSound(time, accented, isSubdivision = false){
  const ctx = state.audioCtx; if(!ctx) return;
  const osc = ctx.createOscillator(); const gain = ctx.createGain();
  
  if (isSubdivision) {
    // Duller sound for subdivisions
    osc.type = "sine";
    osc.frequency.setValueAtTime(800, time);
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime(0.1 * state.subVolume, time + 0.001);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.04);
    osc.start(time); osc.stop(time + 0.06);
  } else {
    // Normal sound for main beats
    osc.type = "square";
    osc.frequency.setValueAtTime(accented ? 1800 : 1200, time);
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime((accented ? 0.3 : 0.2) * state.mainVolume, time + 0.001);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.06);
    osc.start(time); osc.stop(time + 0.08);
  }
  
  osc.connect(gain).connect(ctx.destination);
}
// Calculate interval between beats (in seconds)
function nextIntervalSeconds(){ return (60/state.bpm)*(4/state.beatUnit); }

// --- SETS MANAGEMENT LOGIC ---
// Load a set's parameters into the metronome
function loadSet(setIndex) {
  if (setIndex >= 0 && setIndex < state.sets.length) {
    const set = state.sets[setIndex];
    state.bpm = set.bpm;
    state.beatsPerBar = set.top;
    state.beatUnit = set.bottom;
    state.subdivision = set.subdivision || 1;
    state.currentSet = set;
    state.currentSetIndex = setIndex;
    state.measureIndex = 0;
    
    // Reset beat states for new time signature
    state.beatStates = [];
    
    // Update UI
    els.setBpm.value = set.bpm;
    els.setTop.value = set.top;
    els.setBottom.value = set.bottom;
    els.setMeasures.value = set.measures;
    els.subdivision.value = state.subdivision;
    
    renderBeatStrip();
  }
}

// Advance to the next set in the sequence
function advanceToNextSet() {
  if (state.sets.length > 0 && els.useSetsToggle.checked) {
    const nextIndex = state.currentSetIndex + 1;
    
    // Check if we've reached the end set
    if (nextIndex > state.endSetIndex) {
      if (els.loopToggle.checked) {
        // Loop back to start set
        loadSet(state.startSetIndex);
        renderSets();
      } else {
        // Stop if loop is disabled
        stop();
      }
      return;
    }
    
    loadSet(nextIndex);
    renderSets(); // Update table highlighting
  }
}

// --- SCHEDULER LOGIC ---
// Schedule a main beat note
function scheduleNote(time){
  // Check if this beat should play based on its state
  const beatState = state.beatStates[state.beatIndex];
  if (beatState === 0) {
    // Beat is off, skip sound but still flash LED
    flash(false);
  } else {
    // Beat is on (normal or accented)
    const accented = beatState === 2;

    // --- Voice logic ---
    if (
      els.voiceToggle && els.voiceToggle.checked
    ) {
      let number = state.beatIndex + 1;
      if (number >= 1 && number <= 12) {
        let voiceId = null;
        if (els.voiceBrad && els.voiceBrad.checked) {
          voiceId = "bradVoice" + number;
        } else if (els.voiceGrandpa && els.voiceGrandpa.checked) {
          voiceId = "grandpaVoice" + number;
        } else if (els.voiceSlater && els.voiceSlater.checked) {
          voiceId = "slaterVoice" + number;
        }
        if (voiceId) {
          const audio = document.getElementById(voiceId);
          if (audio) {
            audio.currentTime = 0;
            audio.play();
          }
        }
      }
    }
    // Always play the click sound as well
    clickSound(time, accented);

    flash(accented);
  }
  
  // Check if we're completing a measure
  if (state.beatIndex === state.beatsPerBar - 1) {
    state.measureIndex++;
    if (state.currentSet && els.useSetsToggle.checked && state.measureIndex >= state.currentSet.measures) {
      setTimeout(() => advanceToNextSet(), 100);
      state.measureIndex = 0;
    }
  }
  
  state.beatIndex = (state.beatIndex+1)%state.beatsPerBar;
  scheduleSubdivision(time);
}

// Schedule subdivision notes (between main beats)
function scheduleSubdivision(time) {
  if (state.subdivision > 1) {
    const subdivisionInterval = nextIntervalSeconds() / state.subdivision;
    for (let i = 1; i < state.subdivision; i++) {
      const subdivisionTime = time + (i * subdivisionInterval);
      // Play a duller subdivision click
      clickSound(subdivisionTime, false, true);
    }
  }
}
// Main scheduler loop: schedules notes ahead of time
function scheduler(){
  if(!state.isRunning) return;
  const ctx = state.audioCtx;
  while(state.nextNoteTime < ctx.currentTime+state.scheduleAheadTime){
    scheduleNote(state.nextNoteTime);
    state.nextNoteTime += nextIntervalSeconds();
  }
  state.schedulerId = setTimeout(scheduler,state.lookahead);
}

// --- CONTROL UPDATES ---
// Update state when controls change
els.setBpm.onchange = () => {
  state.bpm = Number(els.setBpm.value);
};

els.setTop.onchange = () => {
  state.beatsPerBar = Number(els.setTop.value);
  renderBeatStrip();
};

els.setBottom.onchange = () => {
  state.beatUnit = Number(els.setBottom.value);
};

els.subdivision.onchange = () => {
  state.subdivision = Number(els.subdivision.value);
};

// --- VOICE TOGGLE LOGIC ---
els.voiceToggle.onchange = () => {
  localStorage.setItem('openmet-voice-enabled', els.voiceToggle.checked ? 'true' : 'false');
};
const savedVoice = localStorage.getItem('openmet-voice-enabled');
if (savedVoice !== null) els.voiceToggle.checked = savedVoice === 'true';

// --- Voice radio logic ---
els.voiceBrad.onchange = () => {
  if (els.voiceBrad.checked) {
    localStorage.setItem('openmet-voice-choice', 'brad');
  }
};
els.voiceGrandpa.onchange = () => {
  if (els.voiceGrandpa.checked) {
    localStorage.setItem('openmet-voice-choice', 'grandpa');
  }
};
els.voiceSlater.onchange = () => {
  if (els.voiceSlater.checked) {
    localStorage.setItem('openmet-voice-choice', 'slater');
  }
};
const savedVoiceChoice = localStorage.getItem('openmet-voice-choice');
if (savedVoiceChoice === 'grandpa') {
  els.voiceGrandpa.checked = true;
  els.voiceBrad.checked = false;
  els.voiceSlater.checked = false;
} else if (savedVoiceChoice === 'slater') {
  els.voiceSlater.checked = true;
  els.voiceBrad.checked = false;
  els.voiceGrandpa.checked = false;
} else {
  // Default to Brad
  els.voiceBrad.checked = true;
  els.voiceGrandpa.checked = false;
  els.voiceSlater.checked = false;
}

function getSelectedVoicePrefix() {
  if (els.voiceBrad && els.voiceBrad.checked) return "bradVoice";
  if (els.voiceGrandpa && els.voiceGrandpa.checked) return "grandpaVoice";
  if (els.voiceSlater && els.voiceSlater.checked) return "slaterVoice";
  return "bradVoice"; // fallback
}

// In playCountoff and scheduleNote, use:
let voicePrefix = getSelectedVoicePrefix();
// ...then use voicePrefix + number for the audio element ID...

// --- START/STOP LOGIC ---
// Start the metronome
function start(){
  initAudio();
  // If countoff is enabled, play it first, then start metronome
  if (els.countoffToggle && els.countoffToggle.checked) {
    els.toggleBtn.disabled = true;
    playCountoff(() => {
      els.toggleBtn.disabled = false;
      actuallyStartMet();
    });
  } else {
    actuallyStartMet();
  }
}

function playCountoff(callback) {
  // Determine which voice
  let voicePrefix = "grandpaVoice";
  if (els.voiceSlater && els.voiceSlater.checked) voicePrefix = "slaterVoice";
  if (els.voiceBrad && els.voiceBrad.checked) voicePrefix = "bradVoice";

  // Calculate interval between beats (in ms)
  const interval = (60 / state.bpm) * (4 / state.beatUnit) * 1000;

  // Schedule: "5" (beat 1), "6" (beat 3), "5,6,7,8" (next 4 beats)
  const sequence = [
    { num: 5, delay: 0 },                // beat 1
    { num: 6, delay: interval * 2 },     // beat 3
    { num: 5, delay: interval * 4 },     // next 4 beats
    { num: 6, delay: interval * 5 },
    { num: 7, delay: interval * 6 },
    { num: 8, delay: interval * 7 }
  ];

  // Play each number at the scheduled time
  sequence.forEach((item) => {
    setTimeout(() => {
      showCountoffNumber(item.num);
      let audioId = voicePrefix + item.num;
      let audio = document.getElementById(audioId);
      if (audio) {
        audio.currentTime = 0;
        audio.play();
      }
    }, item.delay);
  });

  // Hide the overlay right after the last countoff number
  setTimeout(() => {
    hideCountoffNumber();
    callback();
  }, interval * 8);
}

function actuallyStartMet() {
  state.isRunning = true;
  state.measureIndex = 0;
  state.beatIndex = 0; // Reset to beat 1

  // Initialize first set if using sets
  if (els.useSetsToggle.checked && state.sets.length > 0) {
    loadSet(state.startSetIndex);
    renderSets(); // Update table highlighting
  }

  state.nextNoteTime = state.audioCtx.currentTime + 0.05;
  scheduler();

  // Update button appearance
  els.toggleBtn.textContent = "⏹";
  els.toggleBtn.className = "btn danger";
}
// Stop the metronome
function stop(){
  state.isRunning=false;
  clearTimeout(state.schedulerId); state.schedulerId=null;
  
  // Update button appearance
  els.toggleBtn.textContent = "▶";
  els.toggleBtn.className = "btn primary";
  
  // Remove highlighting when stopped
  if (els.useSetsToggle.checked) {
    renderSets();
  }
}

// Toggle function for start/stop button
function toggleMetronome() {
  if (state.isRunning) {
    stop();
  } else {
    start();
  }
}

els.toggleBtn.onclick = toggleMetronome;

// --- VISUALS ---
// Flash the LED for each beat
function flash(accented){
  const isLightMode = document.body.classList.contains("light-mode");
  const defaultColor = isLightMode ? "#e2e8f0" : "#1b2347";
  
  els.led.style.background=accented?"#7c9cff":"#34d399";
  setTimeout(()=>els.led.style.background=defaultColor,80);
  highlightBeat(state.beatIndex);
}
// Render the beat strip (bar of rectangles for each beat)
function renderBeatStrip(){
  els.beatStrip.innerHTML="";
  
  // Initialize beat states if needed
  if (state.beatStates.length !== state.beatsPerBar) {
    state.beatStates = [];
    for (let i = 0; i < state.beatsPerBar; i++) {
      // Default: first beat accented, others normal
      state.beatStates[i] = i === 0 ? 2 : 1;
    }
  }
  
  for(let i=0;i<state.beatsPerBar;i++){
    const div=document.createElement("div");
    div.style.flex="1"; 
    div.style.height="16px"; 
    div.style.borderRadius="6px";
    div.style.cursor="pointer";
    div.style.transition="background-color 0.2s";
    
    // Set background based on beat state
    const isLightMode = document.body.classList.contains("light-mode");
    switch(state.beatStates[i]) {
      case 0: // off
        div.style.background = isLightMode ? "#e2e8f0" : "#1a2145";
        div.style.opacity="0.3";
        break;
      case 1: // normal
        div.style.background = isLightMode ? "#e2e8f0" : "#1a2145";
        div.style.opacity="1";
        break;
      case 2: // accented
        div.style.background="#3b82f6";
        div.style.opacity="1";
        break;
    }
    
    // Add click handler to cycle beat state
    div.onclick = () => cycleBeatState(i);
    
    els.beatStrip.appendChild(div);
  }
}

// Initialize visuals on page load
renderBeatStrip();

// --- RESET FORM INPUTS TO DEFAULTS ON PAGE LOAD ---
function resetToDefaults() {
  els.setBpm.value = "120";
  els.setTop.value = "4";
  els.setBottom.value = "4";
  els.setMeasures.value = "4";
  els.subdivision.value = "1";
  els.setName.value = "";
  els.groupName.value = "";
  els.useSetsToggle.checked = false;
  els.loopToggle.checked = false;
  
  // Load saved light mode preference
  const savedLightMode = localStorage.getItem('openmet-light-mode');
  if (savedLightMode === 'true') {
    els.lightModeToggle.checked = true;
    document.body.classList.add("light-mode");
  } else {
    els.lightModeToggle.checked = false;
    document.body.classList.remove("light-mode");
  }
  
  // Load saved volume preferences
  const savedMainVolume = localStorage.getItem('openmet-main-volume');
  const savedSubVolume = localStorage.getItem('openmet-sub-volume');
  
  if (savedMainVolume !== null) {
    els.mainVolume.value = savedMainVolume;
    els.mainVolumeValue.textContent = savedMainVolume + "%";
    state.mainVolume = savedMainVolume / 100;
  } else {
    els.mainVolume.value = "80";
    els.mainVolumeValue.textContent = "80%";
    state.mainVolume = 0.8;
  }
  
  if (savedSubVolume !== null) {
    els.subVolume.value = savedSubVolume;
    els.subVolumeValue.textContent = savedSubVolume + "%";
    state.subVolume = savedSubVolume / 100;
  } else {
    els.subVolume.value = "60";
    els.subVolumeValue.textContent = "60%";
    state.subVolume = 0.6;
  }
  
  // Reset state to match defaults
  state.bpm = 120;
  state.beatsPerBar = 4;
  state.beatUnit = 4;
  state.subdivision = 1;
  // Volume state is now set above based on localStorage or defaults
  state.sets = [];
  state.currentSetIndex = 0;
  state.beatIndex = 0;
  state.measureIndex = 0;
  state.currentSet = null;
  state.beatStates = [];
  state.startSetIndex = 0;
  state.endSetIndex = 0;
  
  // Re-render to show default beat states
  renderBeatStrip();
}

// Call reset on page load
resetToDefaults();

// --- BEAT STRIP INTERACTION ---
// Cycle a beat's state (off -> normal -> accented -> off)
function cycleBeatState(beatIndex) {
  // Cycle through states: off -> normal -> accented -> off
  state.beatStates[beatIndex] = (state.beatStates[beatIndex] + 1) % 3;
  
  // Update the visual
  const beatElement = els.beatStrip.children[beatIndex];
  if (beatElement) {
    const isLightMode = document.body.classList.contains("light-mode");
    switch(state.beatStates[beatIndex]) {
      case 0: // off
        beatElement.style.background = isLightMode ? "#e2e8f0" : "#1a2145";
        beatElement.style.opacity="0.3";
        break;
      case 1: // normal
        beatElement.style.background = isLightMode ? "#e2e8f0" : "#1a2145";
        beatElement.style.opacity="1";
        break;
      case 2: // accented
        beatElement.style.background="#3b82f6";
        beatElement.style.opacity="1";
        break;
    }
  }
}

// Highlight the current beat in the beat strip
function highlightBeat(i){
  [...els.beatStrip.children].forEach((el,idx)=>{
    el.style.outline= idx===i? "2px solid #7c9cff":"none";
  });
}
</script>
</body>
</html>